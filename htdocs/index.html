<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Basic SEO -->
  <title>Allergy Free Dog — Compare Dog Foods & Find Allergens</title>
  <meta name="description" content="Allergy Free Dog helps dog owners compare ingredients between triggering and safe foods to detect possible allergens like gluten, poultry, soy, peas, and fish.">
  <meta name="keywords" content="dog food allergy, dog food comparison, gluten free dog food, chicken free dog food, dog food allergens, dog nutrition, pet health">
  <meta name="author" content="Allergy Free Dog Team">

  <!-- Open Graph (Facebook, LinkedIn) -->
  <meta property="og:title" content="Allergy Free Dog — Compare Dog Foods & Find Allergens">
  <meta property="og:description" content="Easily compare triggering vs safe foods to find potential allergens in your dog's diet. Works online, free, no signup.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://allergenfreedog.com">
  <meta property="og:image" content="https://allergenfreedog.com/preview-image.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Allergy Free Dog — Compare Dog Foods & Find Allergens">
  <meta name="twitter:description" content="Compare dog foods and spot allergens instantly. Free tool for pet owners.">
  <meta name="twitter:image" content="https://allergenfreedog.com/preview-image.png">

  <!-- Mobile + Theme -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#79C99E">
  
  <style>
    :root{
      --bg:#fbf6ef;           /* soft beige */
      --ink:#274642;          /* dark green-ink */
      --muted:#5a7d75;        
      --primary:#79C99E;      /* soft green */
      --accent:#FF9F68;       /* warm orange */
      --card:#ffffff;         /* cards */
      --ok:#85d1a0;
      --warn:#ffd27a;
      --danger:#ffb0a3;
      --ring: 0 0 0 3px rgb(121 201 158 / .35);
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    a{color:inherit}
    .container{max-width:1100px;margin-inline:auto;padding:24px}
    header{position:sticky;top:0;background:var(--bg)/.8;backdrop-filter:blur(8px);border-bottom:1px solid #e9e1d7;z-index:5}
    .nav{display:flex;align-items:center;gap:16px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;font-size:1.25rem;color:var(--ink)}
    .brand svg{width:28px;height:28px}
    .nav .actions{display:flex;gap:8px}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:400;cursor:pointer;transition:.2s;display:inline-flex;gap:8px;align-items:center}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:2px solid #c6dacd;color:var(--muted)}
    .btn.primary:hover{transform:translateY(-1px);filter:saturate(1.1)}
    .btn.ghost:hover{border-color:var(--primary);color:var(--ink)}
    
    /* Remove underlines from button links */
    .btn{text-decoration:none}
    
    /* Header navigation button consistency */
    .nav .actions .btn{font-size:0.9rem!important;font-weight:600!important;letter-spacing:0.01em!important}
    .nav .actions a.btn{font-size:0.9rem!important;font-weight:600!important;letter-spacing:0.01em!important}
    .nav .actions button.btn{font-size:0.9rem!important;font-weight:600!important;letter-spacing:0.01em!important}
    .nav .actions button{font-size:0.9rem!important;font-weight:600!important;letter-spacing:0.01em!important}

    .hero{padding:40px 0}
    .hero h1{font-size:clamp(1.6rem,1.2rem + 2vw,2.4rem);margin:0 0 8px;font-weight:900}
    .tag{color:var(--accent);font-weight:800}
    .lede{color:var(--muted);max-width:60ch}

   .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
   /* Form inner grid: keep columns independent and equal width so one column's height
     doesn't stretch the other. Use align-items:start to prevent vertical stretching. */
   .form .grid.two-col-form{grid-template-columns:1fr 1fr;align-items:start}
   .form .grid.two-col-form .field{align-self:start}

   /* Add buttons in the food columns should have a fixed height and consistent width */
  .add-food-btn{height:40px;min-height:40px;display:inline-flex;align-items:center;justify-content:center;padding:0 12px;width:100%;max-width:360px}
  .add-food-btn.btn{padding:0 12px}    
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h2{margin:0 0 12px;font-size:1.2rem}

    .field{display:grid;gap:8px;margin:10px 0}
    label{font-weight:700}
    input[type=text], textarea, select{width:100%;padding:12px 14px;border:2px solid #e3e8e4;border-radius:12px;background:white;color:var(--ink);outline:none}
    input:focus, textarea:focus, select:focus{border-color:var(--primary);box-shadow:var(--ring)}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:680px){.row{grid-template-columns:1fr}}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid #eee;vertical-align:top}
    th{background:#f8faf7;text-align:left;position:sticky;top:0;z-index:2}
    tr.hover:hover{background:#faf9f6}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:.8rem;font-weight:700}
    .pill.ok{background:var(--ok)}
    .pill.warn{background:var(--warn)}
    .pill.danger{background:var(--danger)}
    .taglink{color:var(--muted);text-decoration:underline dotted}

    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
    .chip{border:2px solid #c6dacd;border-radius:999px;padding:6px 10px;font-weight:700;color:var(--muted);cursor:pointer}
    .chip.active{background:var(--primary);border-color:var(--primary);color:#fff}

    /* Food Entry Styles */
    .foodEntry{margin-bottom:16px}
    .foodEntry:last-child{margin-bottom:8px}
    .foodEntry select{margin-bottom:8px}
    .foodEntry textarea{margin-top:8px}
    .foodEntry .btn{font-size:0.8rem;padding:4px 8px;margin-top:4px}

    /* Non-similar ingredient row highlighting */
    tr.non-similar{background-color:#fff3e0}
    tr.non-similar:hover{background-color:#ffe0b2}
 
    /* Ingredient Auto-suggestion Styles */
    .ingredient-suggestions {
      position: absolute;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 8px;
      box-shadow: var(--shadow);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      width: 100%;
      display: none;
    }
    
    .ingredient-suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }
    
    .ingredient-suggestion-item:hover {
      background-color: var(--primary);
      color: white;
    }
    
    .ingredient-suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-highlight {
      background-color: var(--accent);
      color: white;
      padding: 1px 2px;
      border-radius: 2px;
    }
    
    .foodEntry {
      position: relative;
    }

    footer{margin-top:40px;border-top:1px solid #e9e1d7}
    footer .inner{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:center;padding:18px 0;color:var(--muted)}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:24px;z-index:10;overflow-y:auto}
    .modal.open{display:flex}
    @media (max-height: 600px) {
      .modal{align-items:flex-start;padding-top:60px}
    }
    .modal .sheet{max-width:900px;width:100%;background:var(--card);border-radius:20px;box-shadow:var(--shadow)}
    .modal-content{max-width:500px;width:100%;background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:0;overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:1px solid #e9e1d7}
    .modal-header h2{margin:0;color:var(--ink)}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{color:var(--ink)}
    .modal-body{padding:24px}
    #loginBtn:hover{background:#3367d6 !important; transform:translateY(-1px); box-shadow:0 4px 12px rgba(66,133,244,0.3)}
    #firebaseGoogleSignIn:hover{box-shadow:0 2px 8px rgba(0,0,0,0.15); transform:translateY(-1px); border-color:#4285f4}
    
    /* User Profile Styles */
    .user-profile{position:relative; display:flex; align-items:center; gap:12px; cursor:pointer; padding:8px 12px; border-radius:12px; transition:all 0.2s; background:rgba(255,255,255,0.1); backdrop-filter:blur(10px)}
    .user-profile:hover{background:rgba(255,255,255,0.2); transform:translateY(-1px)}
    .profile-avatar{position:relative; width:40px; height:40px; border-radius:50%; border:2px solid var(--primary); overflow:hidden; flex-shrink:0}
    .profile-avatar img{width:100%; height:100%; object-fit:cover}
    .profile-initials{width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg, var(--primary), var(--accent)); color:white; font-weight:600; font-size:16px; text-transform:uppercase}
    .profile-name{color:var(--ink); font-weight:500; font-size:14px; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex-shrink:1}
    .profile-dropdown{position:absolute; top:100%; right:0; background:var(--card); border-radius:12px; box-shadow:var(--shadow); padding:8px; min-width:120px; opacity:0; visibility:hidden; transform:translateY(-10px); transition:all 0.2s; z-index:1000; border:1px solid #e9e1d7}
    .profile-dropdown .btn{width:100%; justify-content:flex-start; margin:0; padding:8px 12px; font-size:14px}
    .profile-dropdown .btn:hover{background:var(--primary); color:white}
    
    /* Dog Selector Section Styles */
    .dog-selector-section{background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding:24px 0; border-bottom:1px solid #e9e1d7}
    .dog-selector-card{background:white; border-radius:16px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); border:1px solid #e9e1d7; text-align:center}
    .dog-selector-header{margin-bottom:20px}
    .dog-selector-header h2{margin:0 0 8px 0; color:var(--ink); font-size:24px; font-weight:600}
    .dog-selector-header p{margin:0; color:var(--muted); font-size:16px}
    .dog-selector-controls{display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap}
    .dog-dropdown{padding:12px 16px; border:2px solid #e9e1d7; border-radius:12px; background:white; color:var(--ink); font-size:16px; min-width:200px; cursor:pointer; transition:all 0.2s}
    .dog-dropdown:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(121,201,158,0.2)}
    .dog-dropdown:hover{border-color:var(--primary)}
    
    /* Current Dog Indicator */
    .current-dog-indicator{background:linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border:2px solid var(--primary); border-radius:12px; padding:12px 16px; margin:16px 0; display:flex; align-items:center; gap:8px; animation:slideIn 0.3s ease-out}
    .indicator-icon{font-size:20px}
    .indicator-text{color:var(--ink); font-size:14px; font-weight:500}
    .indicator-text strong{color:var(--primary)}
    
    @keyframes slideIn{from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)}}
    
    /* Safe Food Suggestions Styles */
    .suggestions-container{max-width:100%; margin:0 auto}
    .suggestions-grid{display:flex; gap:16px; margin:20px 0; justify-content:flex-start; flex-wrap:nowrap; overflow-x:auto; padding:0 10px; scrollbar-width:thin; scrollbar-color:var(--primary) #f0f0f0}
    .suggestions-grid::-webkit-scrollbar{height:6px}
    .suggestions-grid::-webkit-scrollbar-track{background:#f0f0f0; border-radius:3px}
    .suggestions-grid::-webkit-scrollbar-thumb{background:var(--primary); border-radius:3px}
    .suggestions-grid::-webkit-scrollbar-thumb:hover{background:var(--primary-dark)}
    .product-card{background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); border:1px solid #e9e1d7; overflow:hidden; transition:all 0.3s ease; width:250px; min-width:250px; flex-shrink:0; text-decoration:none; color:inherit}
    .product-card:hover{transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,0.15); text-decoration:none; color:inherit}

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .product-image{width:100%; height:180px; object-fit:cover; background:#f8f9fa; display:flex; align-items:center; justify-content:center; font-size:48px; color:#ddd}
    .product-info{padding:16px; text-align:center}
    .product-name{font-weight:600; font-size:14px; line-height:1.4; margin:0 0 8px 0; color:var(--ink); display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    .product-price{color:var(--primary); font-weight:600; font-size:16px; margin:8px 0 0 0}
    .product-rating{display:flex; align-items:center; justify-content:center; gap:4px; margin:8px 0; font-size:12px; color:var(--muted)}
    .product-stars{color:#ffc107}
    .affiliate-badge{background:linear-gradient(135deg, #ff9500 0%, #ff6b00 100%); color:white; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-top:8px; display:inline-block}
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .profile-name{max-width:80px; font-size:13px}
      .user-profile{padding:6px 8px; gap:8px}
      .profile-avatar{width:32px; height:32px}
      .profile-initials{font-size:14px}
      .dog-selector-section{padding:16px 0}
      .dog-selector-card{padding:16px}
      .dog-selector-header h2{font-size:20px}
      .dog-selector-header p{font-size:14px}
      .dog-selector-controls{flex-direction:column; gap:8px}
      .dog-dropdown{min-width:180px; font-size:14px}
      .suggestions-grid{gap:12px; padding:0 5px}
      .product-card{width:200px; min-width:200px; flex-shrink:0}
      .product-image{height:150px}
      .product-name{font-size:13px}
      .product-price{font-size:14px}
    }
    .sheet .head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #eef2ef}
    .sheet h3{margin:0}
    .sheet .body{padding:12px 18px 22px}
    .glossary{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
   /* Keep glossary content from stretching the modal and allow internal scrolling
     when there are many results. When there are few results, align to start to
     prevent large empty gaps or layout shifts. */
   .modal .sheet .body{max-height:60vh;overflow:auto}
   .glossary{align-content:start;grid-auto-rows:minmax(min-content, max-content)}
    .gloss{border:1px solid #edf0ee;border-radius:14px;padding:10px}
    .gloss h4{margin:0 0 6px}
    .muted{color:var(--muted)}
    .sr{position:absolute;left:-10000px}
  </style>
  
  <!-- Favicon and meta tags -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <!-- <link rel="alternate icon" href="/favicon.ico"> -->
  <meta name="theme-color" content="#79C99E">

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Allergy Free Dog",
      "url": "https://allergenfreedog.com",
      "description": "A free online tool to compare dog food ingredients and detect potential allergens like gluten, poultry, soy, peas, and fish.",
      "applicationCategory": "PetCareApplication",
      "operatingSystem": "Any",
      "creator": {
        "@type": "Organization",
        "name": "Allergy Free Dog"
      },
      "keywords": ["dog food allergy", "pet nutrition", "dog food comparison", "allergen detection"],
      "featureList": [
        "Compare triggering vs safe foods",
        "Highlight potential allergens",
        "Ingredient glossary",
        "Safe food tester"
      ]
    }
  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4D9WRY7LV3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-4D9WRY7LV3');
  </script>
    
</head>
<body>
  <!-- Firebase SDKs (Auth + Firestore) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <header>
    <div class="container nav">
      <div class="brand" aria-label="allergenfreedog brand">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M20 20c0-4 3-7 7-7s7 3 7 7-3 7-7 7-7-3-7-7Z" fill="#79C99E"/><circle cx="48" cy="20" r="6" fill="#79C99E"/><circle cx="17" cy="36" r="5" fill="#79C99E"/><circle cx="35" cy="43" r="5" fill="#79C99E"/><path d="M20 53c6 5 18 5 24 0 5-4 6-11 2-16-6-7-22-7-28 0-4 5-3 12 2 16Z" fill="#FF9F68"/></svg>
        Allergen Free Dog
      </div>
      <div class="actions">
        <button class="btn ghost" id="openGlossary">Ingredient Glossary</button>
        <a class="btn ghost" href="allergy-testing.html">Allergy Testing Guide</a>
        <button class="btn" id="loginBtn" style="display: none; background: #4285f4; color: white; border: none;">Log In</button>
        <div id="userInfo" style="display: none;">
          <div id="userProfile" class="user-profile">
            <div class="profile-avatar">
              <img id="userAvatar" src="" alt="Profile" style="display: none;">
              <div id="userInitials" class="profile-initials"></div>
            </div>
            <span id="userName" class="profile-name"></span>
            <div class="profile-dropdown">
              <button class="btn ghost" id="logoutBtn">Log Out</button>
            </div>
          </div>
        </div>
        <a class="btn primary" href="#compare">Compare Now</a>
      </div>
    </div>
  </header>

  <!-- Dog Selector Section -->
  <div id="dogSelectorSection" class="dog-selector-section" style="display: none;">
    <div class="container">
      <div class="dog-selector-card">
        <div class="dog-selector-header">
          <h2>🐾 Working with <span id="currentDogName">your dog</span></h2>
          <p>All comparisons below will be saved for this dog</p>
        </div>
        <div class="dog-selector-controls">
          <select id="dogSelectDropdown" class="dog-dropdown">
            <option value="">Select a dog...</option>
          </select>
          <button id="addNewDog" class="btn primary">+ Add New Dog</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Direct Login Dialog Modal -->
  <div id="loginDialog" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sign In</h2>
        <button class="modal-close" id="closeLoginDialog">&times;</button>
      </div>
      <div class="modal-body">
        <p>Sign in with Google to access your saved data and preferences.</p>
        <div id="googleSignInButton" style="margin: 20px 0;"></div>
        <div id="dogManagement" style="display: none;">
          <h3>Your Dogs</h3>
          <div id="dogList"></div>
          <div id="createDogSection">
            <input type="text" id="newDogName" placeholder="Enter dog name" style="margin-right: 8px;">
            <button id="addDogBtn" class="btn primary">Add Dog</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Comparison Dialog Modal -->
  <div id="saveComparisonDialog" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sign In to Save Comparisons</h2>
        <button class="modal-close" id="closeSaveComparisonDialog">&times;</button>
      </div>
      <div class="modal-body">
        <p>Sign in with Google to save your dog profiles and food comparisons for later. This allows you to:</p>
        <ul style="margin: 16px 0; padding-left: 20px;">
          <li>Save comparison results for each of your dogs</li>
          <li>Load previous comparisons instantly</li>
          <li>Get personalized suggestions based on your dog's history</li>
        </ul>
        <div id="saveComparisonGoogleSignInButton" style="margin: 20px 0;"></div>
        <p style="font-size: 14px; color: var(--muted); margin-top: 16px;">
          Don't worry - you can still use the comparison tool without signing in!
        </p>
      </div>
    </div>
  </div>

  <!-- Welcome Dialog Modal -->
  <div id="welcomeDialog" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Welcome to Allergy Free Dog! 🐾</h2>
        <button class="modal-close" id="closeWelcomeDialog">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center; margin-bottom: 24px;">
          <div style="font-size: 48px; margin-bottom: 16px;">🎉</div>
          <p style="font-size: 18px; color: var(--ink); margin-bottom: 16px;">
            You're now signed in! Let's get started by creating a profile for your dog.
          </p>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
          <h3 style="margin: 0 0 12px 0; color: var(--ink);">What you can do now:</h3>
          <ul style="margin: 0; padding-left: 20px; color: var(--muted);">
            <li>Create profiles for each of your dogs</li>
            <li>Save food comparisons for each dog</li>
            <li>Track which foods work best for each dog</li>
            <li>Load previous comparisons instantly</li>
          </ul>
        </div>

        <div style="margin-bottom: 20px;">
          <label for="firstDogName" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">
            What's your dog's name?
          </label>
          <input 
            type="text" 
            id="firstDogName" 
            placeholder="Enter your dog's name..." 
            style="width: 100%; padding: 12px; border: 2px solid #e9e1d7; border-radius: 8px; font-size: 16px;"
            maxlength="50"
          >
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button id="skipWelcome" class="btn ghost">Skip for now</button>
          <button id="createFirstDogFromWelcome" class="btn primary">Create Dog Profile</button>
        </div>
      </div>
    </div>
  </div>

  <!-- auth panel removed; login handled via dialog (not inlined) -->

<!-- dog panel removed; dog management via login dialog and Firestore flow -->

  <div id="noDogsMessage" class="container card" style="margin:12px 0; display:none;">
    <p>No dogs found for your account. Create a dog to start saving comparisons and getting suggestions.</p>
    <button id="createFirstDog" class="btn primary">Create Your First Dog</button>
  </div>

  <main class="container hero">
    <div class="grid">
      <section class="card">
        <h1><span class="tag">Compare dog foods</span> and spot allergens instantly 🐾</h1>
        <div id="currentDogIndicator" class="current-dog-indicator" style="display: none;">
          <span class="indicator-icon">🐕</span>
          <span class="indicator-text">Showing data for <strong id="indicatorDogName">your dog</strong></span>
        </div>
        <p class="lede">Paste labels or pick built‑ins. We normalise ingredients and highlight <strong>gluten</strong>, <strong>poultry</strong>, common <strong>allergens</strong>, and <strong>overlaps</strong>. Fully client‑side — just upload this file to your InfinityFree hosting.</p>

        <form id="compare" class="form" aria-labelledby="compareHeading">
          <h2 id="compareHeading">Compare Dog Foods</h2>

          <!-- per-column brand filters moved into each column for scoped filtering -->

          <div class="grid two-col-form">
            <div class="field">
              <label>Triggering Foods (Foods that caused problems)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <small class="muted">Filter by brand:</small>
                  <select class="brandFilter"><option value="">All brands</option></select>
                </div>
              <div id="triggeringFoods">
                <div class="foodEntry">
                  <select class="foodSelect" aria-describedby="triggeringHelp"></select>
                  <small class="muted">Pick a sample or "Custom (paste)"</small>
                  <textarea class="foodText" rows="3" placeholder="Paste ingredients separated by commas…"></textarea>
                  <div class="ingredient-suggestions" id="triggeringSuggestions"></div>
                </div>
              </div>
              <button type="button" class="btn ghost add-food-btn" id="addTriggeringFood">+ Add Another Triggering Food</button>
            </div>
            
            <div class="field">
              <label>Safe Foods (Foods that didn't cause problems)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <small class="muted">Filter by brand:</small>
                  <select class="brandFilter"><option value="">All brands</option></select>
                </div>
              <div id="safeFoods">
                <div class="foodEntry">
                  <select class="foodSelect" aria-describedby="safeHelp"></select>
                  <small class="muted">Pick a sample or "Custom (paste)"</small>
                  <textarea class="foodText" rows="3" placeholder="Paste ingredients separated by commas…"></textarea>
                  <div class="ingredient-suggestions" id="safeSuggestions"></div>
            </div>
          </div>
              <button type="button" class="btn ghost add-food-btn" id="addSafeFood">+ Add Another Safe Food</button>
            </div>
          </div>

          <div class="row" style="align-items:center">
            <div class="field">
              <label class="sr" for="safe">Preference toggles</label>
              <div class="filters">
                <label class="chip"><input type="checkbox" id="noGluten" checked> Gluten-free focus</label>
                <label class="chip"><input type="checkbox" id="noPoultry" checked> Chicken-free focus</label>
                <label class="chip"><input type="checkbox" id="hydrolysedLow" checked> Treat hydrolysed as low risk</label>
              </div>
            </div>
            <div class="field" style="text-align:right">
              <button type="submit" class="btn primary">Build Comparison</button>
              <button type="button" id="saveComparisonBtn" class="btn ghost" style="margin-left:8px;" disabled>Save Comparison</button>
            </div>
          </div>
        </form>
      </section>

      <aside class="card">
        <h2>How it works</h2>
        <ol>
          <li><strong>Triggering Foods:</strong> Add foods your dog ate that caused problems (allergies, upset stomach, etc.)</li>
          <li><strong>Safe Foods:</strong> Add foods your dog ate without any issues</li>
          <li>We normalise common ingredient names using an internal list.</li>
          <li>We identify "non-similar ingredients" - ingredients present in triggering foods but NOT in safe foods.</li>
          <li>We build a comparison table showing overlaps and allergen notes.</li>
          <li><strong>Safe Food Finder:</strong> After comparison, test new dog foods to see if they contain any "non-similar ingredients" that could cause problems.</li>
        </ol>
        <p class="muted">Tip: hydrolysed proteins are treated as low risk if you toggle it on.</p>
      </aside>
    </div>

    <section class="card" id="results" aria-live="polite" style="margin-top:18px">
      <h2>Results</h2>
      <div id="resultNote" class="muted">Fill the form above and click <em>Build Comparison</em>.</div>
      <div class="filters" id="legend" hidden>
        <span class="pill danger">High: gluten/poultry</span>
        <span class="pill warn">Possible: soy/corn/peas/yeast/fish</span>
        <span class="pill ok">Safe (based on filters)</span>
      </div>
      <div class="filters" role="group" aria-label="Filters" style="margin-bottom: 16px; display: flex; gap: 8px; justify-content: center;">
        <button type="button" class="chip active" data-filter="showAll">Show all</button>
        <button type="button" class="chip" data-filter="allergens">Allergens only</button>
        <button type="button" class="chip" data-filter="overlap">Overlaps only</button>
      </div>
      <div style="overflow:auto">
        <table id="compareTable"></table>
      </div>
    </section>

    <!-- Safe Food Suggestions Section -->
    <section class="card" id="safeFoodSuggestions" style="margin-top: 18px; display: none;">
      <h2>🐾 Recommended Safe Foods</h2>
      <p class="muted">Based on your comparison, here are safe dog foods that don't contain the problematic ingredients:</p>
      
      <div class="suggestions-container">
        <div class="suggestions-grid" id="suggestionsGrid">
          <!-- Product cards will be dynamically inserted here -->
        </div>
      </div>
      
      <div class="suggestions-footer" style="text-align: center; margin-top: 16px;">
        <p class="muted" style="font-size: 14px;">
          <em>These recommendations are based on ingredient analysis. Make sure to check the ingredients before you try it out. Always consult with your veterinarian before changing your dog's diet.</em>
        </p>
      </div>
    </section>

    <section class="card" id="safeFoodFinder" aria-live="polite" style="margin-top:18px; display: none;">
      <h2>Safe Food Finder</h2>
      <p class="muted">Test a new dog food to see if it contains any ingredients that could cause problems for your dog.</p>
      
      <div class="row">
        <div class="field">
          <label for="newFoodName">Food Name</label>
          <input type="text" id="newFoodName" placeholder="Enter the name of the food to test">
        </div>
        <div class="field">
          <label for="newFoodIngredients">Ingredients</label>
          <textarea id="newFoodIngredients" rows="3" placeholder="Paste ingredients separated by commas…"></textarea>
          <div class="ingredient-suggestions" id="newFoodSuggestions"></div>
        </div>
      </div>
      
      <div class="field" style="text-align:right">
        <button type="button" class="btn primary" id="testNewFood">Test Food Safety</button>
      </div>
      
      <div id="safetyResult" style="margin-top: 16px; display: none;">
        <h3 id="safetyTitle"></h3>
        <div id="safetyDetails"></div>
        <div id="ingredientTable" style="margin-top: 16px; display: none;">
          <h4>Ingredient Analysis</h4>
          <div style="overflow: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="padding: 12px 10px; border-bottom: 1px solid #eee; background: #f8faf7; text-align: left;">Ingredient Name</th>
                  <th style="padding: 12px 10px; border-bottom: 1px solid #eee; background: #f8faf7; text-align: left;">Status</th>
                  <th style="padding: 12px 10px; border-bottom: 1px solid #eee; background: #f8faf7; text-align: left;">Similar To (if problematic)</th>
                </tr>
              </thead>
              <tbody id="ingredientTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container inner">
      <small>© <span id="yr"></span> allergenfreedog • For information only — not veterinary advice.</small>
      <a href="#" id="openGlossary2" class="taglink">Open ingredient glossary</a>
    </div>
  </footer>

  <!-- Glossary Modal -->
  <div class="modal" id="glossaryModal" aria-hidden="true" role="dialog" aria-labelledby="gTitle">
    <div class="sheet">
      <div class="head">
        <h3 id="gTitle">Ingredient Glossary</h3>
        <button class="btn ghost" id="closeGlossary" aria-label="Close">Close</button>
      </div>
      <div class="body">
        <div class="field">
          <label for="gSearch">Search</label>
          <input id="gSearch" type="text" placeholder="Type to filter…" />
        </div>
        <div class="glossary" id="glossary"></div>
      </div>
    </div>
  </div>

  <script>
  // Global variables
  let nonSimilarIngredients = [];
  let triggeringFoodsData = [];
  let foodCatalog = [];
  let ingredientMaster = [];
  // store last comparison so toggles can re-render without re-calling the API
  let lastComparison = null;
  
  // Auth and Firebase variables
  let gisUser = null;
  let currentDogId = null;
  let userDogs = [];
  let auth = null;
  let db = null;

    // Initialize the application
    async function initializeApp() {
      try {
        await Promise.all([
          loadFoodCatalog(),
          loadIngredientMaster()
        ]);
  // populate brand filter then initialize entries
  populateBrandFilter();
  initializeFoodEntries();
        console.log('Application initialized successfully');
      } catch (error) {
        console.error('Failed to initialize application:', error);
        showError('Failed to load application data. Please refresh the page.');
      }
    }

    function populateBrandFilter(){
      // Build a map of lowercase -> original casing (first occurrence)
      const brandMap = {};
      foodCatalog.forEach(f => {
        const raw = (f.brand||'').trim();
        if(!raw) return;
        const key = raw.toLowerCase();
        if(!(key in brandMap)) brandMap[key] = raw; // keep first/original casing
      });
      const keys = Object.keys(brandMap).sort();
      // populate every per-column brandFilter
      document.querySelectorAll('.brandFilter').forEach(sel=>{
        sel.innerHTML = '<option value="">All brands</option>' + keys.map(k=>`<option value="${k}">${brandMap[k]}</option>`).join('');
        // ensure single listener: replace node
        const newSel = sel.cloneNode(true);
        sel.parentNode.replaceChild(newSel, sel);
        newSel.addEventListener('change', ()=>{
          // refresh only the selects inside the same column (closest .field parent)
          const field = newSel.closest('.field');
          if(!field) return;
          const brandFilter = (newSel.value||'').trim().toLowerCase();
          field.querySelectorAll('.foodEntry').forEach(fe=>{
            const selEl = fe.querySelector('.foodSelect');
            const prev = selEl.value;
            selEl.innerHTML='';
            const noneOp = document.createElement('option'); noneOp.value='(none)'; noneOp.textContent='(none)'; selEl.append(noneOp);
            foodCatalog.filter(f => !brandFilter || ((f.brand||'').trim().toLowerCase() === brandFilter)).forEach(f => {
              const text = `${f.brand}${f.brand? ' - ':' '}${f.name}`.trim();
              const op = document.createElement('option'); op.value = text; op.textContent = text; selEl.append(op);
            });
            const customOp = document.createElement('option'); customOp.value='Custom (paste)'; customOp.textContent='Custom (paste)'; selEl.append(customOp);
            try{ selEl.value = prev; }catch(e){}
          });
        });
      });
    }

    // Load food catalog from API
    async function loadFoodCatalog() {
      try {
        const response = await fetch('api/food_catalog.php');
        const result = await response.json();
        
        if (result.success) {
          foodCatalog = result.data;
        } else {
          throw new Error(result.message || 'Failed to load food catalog');
        }
      } catch (error) {
        console.error('Error loading food catalog:', error);
        throw error;
      }
    }

    // Load ingredient master list from API
    async function loadIngredientMaster() {
      try {
        const response = await fetch('api/ingredients.php');
        const result = await response.json();
        
        if (result.success) {
          ingredientMaster = result.data;
        } else {
          throw new Error(result.message || 'Failed to load ingredient master list');
        }
      } catch (error) {
        console.error('Error loading ingredient master list:', error);
        throw error;
      }
    }

    // Initialize food entry functionality
    function initializeFoodEntries() {
      // Set up initial food entries
      setupFoodEntry(document.querySelector('#triggeringFoods .foodEntry'), 'Sample Brand - Insect & Pea');
      setupFoodEntry(document.querySelector('#safeFoods .foodEntry'), '(none)');
      
      // Add event listeners for adding new foods
      document.getElementById('addTriggeringFood').addEventListener('click', () => addNewFood('triggeringFoods'));
      document.getElementById('addSafeFood').addEventListener('click', () => addNewFood('safeFoods'));
      
      // Set up ingredient suggestions for safe food finder
      setupIngredientSuggestions('newFoodIngredients', 'newFoodSuggestions');
    }

    function setupIngredientSuggestions(textareaId, suggestionsId) {
      const textarea = document.getElementById(textareaId);
      const suggestionsDiv = document.getElementById(suggestionsId);
      
      textarea.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        if (query.length < 2) {
          suggestionsDiv.style.display = 'none';
          return;
        }
        
        // Get the last word being typed (for comma-separated lists)
        const words = query.split(/[,\n]/);
        const lastWord = words[words.length - 1].trim();
        
        if (lastWord.length < 2) {
          suggestionsDiv.style.display = 'none';
          return;
        }
        
        // Find matching ingredients from master list
        const matches = ingredientMaster
          .filter(ingredient => cleanIngredientName(ingredient.name).includes(lastWord))
          .slice(0, 8); // Limit to 8 suggestions
        
        renderIngredientSuggestions(matches, suggestionsDiv, textarea, lastWord);
      });
      
      // Hide suggestions when textarea loses focus
      textarea.addEventListener('blur', () => {
        setTimeout(() => {
          suggestionsDiv.style.display = 'none';
        }, 200);
      });
      
      // Show suggestions when textarea gains focus (if there's text)
      textarea.addEventListener('focus', () => {
        const query = textarea.value.toLowerCase();
        if (query.length >= 2) {
          const words = query.split(/[,\n]/);
          const lastWord = words[words.length - 1].trim();
          if (lastWord.length >= 2) {
            const matches = ingredientMaster
              .filter(ingredient => cleanIngredientName(ingredient.name).includes(lastWord))
              .slice(0, 8);
            renderIngredientSuggestions(matches, suggestionsDiv, textarea, lastWord);
          }
        }
      });
    }

    function renderIngredientSuggestions(matches, suggestionsDiv, textarea, query) {
      suggestionsDiv.innerHTML = '';
      
      if (matches.length === 0) {
        suggestionsDiv.innerHTML = '<div class="ingredient-suggestion-item">No matches found</div>';
        suggestionsDiv.style.display = 'block';
        return;
      }
      
      matches.forEach(match => {
        const item = document.createElement('div');
        item.className = 'ingredient-suggestion-item';
        
        // Highlight the matching part
        const displayName = match.name;
        const highlightedName = displayName.replace(
          new RegExp(`(${query})`, 'gi'),
          '<span class="suggestion-highlight">$1</span>'
        );
        
        item.innerHTML = highlightedName;
        
        // Add note if available
        if (match.note) {
          const noteSpan = document.createElement('div');
          noteSpan.style.fontSize = '0.8em';
          noteSpan.style.color = 'var(--muted)';
          noteSpan.textContent = match.note;
          item.appendChild(noteSpan);
        }
        
        item.addEventListener('click', () => {
          // Replace the last word with the selected ingredient
          const currentValue = textarea.value;
          const words = currentValue.split(/[,\n]/);
          words[words.length - 1] = match.name;
          textarea.value = words.join(', ');
          
          // Hide suggestions
          suggestionsDiv.style.display = 'none';
          
          // Focus back to textarea
          textarea.focus();
        });
        
        suggestionsDiv.appendChild(item);
      });
      
      suggestionsDiv.style.display = 'block';
    }

    function setupFoodEntry(entry, defaultValue) {
      const select = entry.querySelector('.foodSelect');
      const textarea = entry.querySelector('.foodText');
      const suggestionsDiv = entry.querySelector('.ingredient-suggestions');
      
      // Build options for this select respecting brand filter
      // look for a local per-column brandFilter select inside the closest .field
      let brandFilter = '';
      const colField = entry.closest('.field');
      if(colField){
        const bf = colField.querySelector('.brandFilter');
        if(bf) brandFilter = (bf.value||'').trim().toLowerCase();
      }
  const noneOp = document.createElement('option'); noneOp.value='(none)'; noneOp.textContent='(none)'; select.append(noneOp);
  foodCatalog.filter(f => !brandFilter || ((f.brand||'').trim().toLowerCase() === brandFilter)).forEach(f => {
        const op = document.createElement('option');
        const text = `${f.brand}${f.brand? ' - ':' '}${f.name}`.trim();
        op.value = text;
        op.textContent = text;
        select.append(op);
      });
      const customOp = document.createElement('option'); customOp.value='Custom (paste)'; customOp.textContent='Custom (paste)'; select.append(customOp);
      
      select.value = defaultValue;
      
      // Set up change handler
      function updateTextarea() {
        const v = select.value;
        if(v !== "(none)" && v !== "Custom (paste)") {
          // Extract the food name from "Brand - Food Name" format
          const foodName = v.split(' - ').slice(1).join(' - ');
          const selectedFood = foodCatalog.find(f => f.name === foodName);
          if(selectedFood) {
            textarea.value = selectedFood.ingredients;
            textarea.disabled = false;
          }
        }
        else if(v==="(none)"){ 
          textarea.value = ''; 
          textarea.disabled = true; 
        }
        else { 
          textarea.value = '';
          textarea.placeholder = 'Paste ingredients separated by commas…'; 
          textarea.disabled = false; 
        }
      }
      
      select.addEventListener('change', updateTextarea);
      updateTextarea();
       
       // Set up ingredient suggestions for the textarea
       setupTextareaSuggestions(textarea, entry);
     }

     function setupTextareaSuggestions(textarea, entry) {
       const suggestionsDiv = entry.querySelector('.ingredient-suggestions');
       
       textarea.addEventListener('input', (e) => {
         const query = e.target.value.toLowerCase();
         if (query.length < 2) {
           suggestionsDiv.style.display = 'none';
           return;
         }
         
         // Get the last word being typed (for comma-separated lists)
         const words = query.split(/[,\n]/);
         const lastWord = words[words.length - 1].trim();
         
         if (lastWord.length < 2) {
           suggestionsDiv.style.display = 'none';
           return;
         }
         
         // Find matching ingredients from master list
         const matches = ingredientMaster
           .filter(ingredient => cleanIngredientName(ingredient.name).includes(lastWord))
           .slice(0, 8); // Limit to 8 suggestions
         
         renderIngredientSuggestions(matches, suggestionsDiv, textarea, lastWord);
       });
       
       // Hide suggestions when textarea loses focus
       textarea.addEventListener('blur', () => {
         setTimeout(() => {
           suggestionsDiv.style.display = 'none';
         }, 200);
       });
       
       // Show suggestions when textarea gains focus (if there's text)
       textarea.addEventListener('focus', () => {
         const query = textarea.value.toLowerCase();
         if (query.length >= 2) {
           const words = query.split(/[,\n]/);
           const lastWord = words[words.length - 1].trim();
           if (lastWord.length >= 2) {
             const matches = ingredientMaster
               .filter(ingredient => cleanIngredientName(ingredient.name).includes(lastWord))
               .slice(0, 8);
             renderIngredientSuggestions(matches, suggestionsDiv, textarea, lastWord);
           }
         }
       });
     }

    function addNewFood(containerId) {
      const container = document.getElementById(containerId);
      const newEntry = document.createElement('div');
      newEntry.className = 'foodEntry';
      newEntry.style.marginTop = '12px';
      
      newEntry.innerHTML = `
        <div style="display: flex; gap: 8px; align-items: center;">
          <select class="foodSelect"></select>
          <button type="button" class="btn ghost" style="padding: 4px 8px; font-size: 0.8rem;" onclick="removeFoodEntry(this)">Remove</button>
        </div>
        <small class="muted">Pick a sample or "Custom (paste)"</small>
        <textarea class="foodText" rows="3" placeholder="Paste ingredients separated by commas…"></textarea>
        <div class="ingredient-suggestions" id="newFoodSuggestions"></div>
      `;
      
      container.appendChild(newEntry);
      setupFoodEntry(newEntry, '(none)');
    }

    function removeFoodEntry(button) {
      button.closest('.foodEntry').remove();
    }

    // Filters
    let currentFilter = 'showAll';
    document.querySelectorAll('.chip[data-filter]').forEach(ch=>{
      ch.addEventListener('click',()=>{
        document.querySelectorAll('.chip[data-filter]').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active'); currentFilter = ch.dataset.filter; applyRowFilter();
      });
    });

    function collectProducts(){
      const triggering = [];
      const safe = [];
      
      // Collect triggering foods
      document.querySelectorAll('#triggeringFoods .foodEntry').forEach(entry => {
        const selectValue = entry.querySelector('.foodSelect').value;
        const txt = entry.querySelector('.foodText').value.trim();
        if(selectValue !== "(none)" && txt){ 
          // Extract food name from "Brand - Food Name" format
          const foodName = selectValue.split(' - ').slice(1).join(' - ');
          triggering.push({label: `Triggering: ${foodName}`, list: parseList(txt)}); 
        }
      });
      
      // Collect safe foods
      document.querySelectorAll('#safeFoods .foodEntry').forEach(entry => {
        const selectValue = entry.querySelector('.foodSelect').value;
        const txt = entry.querySelector('.foodText').value.trim();
        if(selectValue !== "(none)" && txt){ 
          // Extract food name from "Brand - Food Name" format
          const foodName = selectValue.split(' - ').slice(1).join(' - ');
          safe.push({label: `Safe: ${foodName}`, list: parseList(txt)}); 
        }
      });
      
      return { triggering, safe };
    }

    function parseList(text){
      return text
        .split(/,|;|\n/)
        .map(x => x
          .trim()
          .replace(/\s+/g, ' ')           // Replace multiple spaces with single space
          .replace(/[\u200B-\u200D\uFEFF]/g, '') // Remove zero-width spaces and BOM
          .replace(/[\u00A0\u1680\u180e\u2000-\u200a\u202f\u205f\u3000]/g, ' ') // Replace various space characters with regular space
          .trim()
        )
        .filter(x => x.length > 0)        // Remove empty strings
        .map(x => x.toLowerCase());        // Convert to lowercase for consistency
    }

    // Utility function to clean ingredient names consistently
    function cleanIngredientName(name) {
      return name
        .trim()
        .replace(/\s+/g, ' ')           // Replace multiple spaces with single space
        .replace(/[\u200B-\u200D\uFEFF]/g, '') // Remove zero-width spaces and BOM
        .replace(/[\u00A0\u1680\u180e\u2000-\u200a\u202f\u205f\u3000]/g, ' ') // Replace various space characters with regular space
        .trim()
        .toLowerCase();
    }

    function allergenClass(name, prefs){
      const raw = cleanIngredientName(name);
      // detect hydrolysed word anywhere
      const hydroRegex = /\bhydroly(s|z)ed\b|\bhydroly(s|z)sed\b/g;
      const hasHydro = hydroRegex.test(raw);

      // helper: try to find a matching ingredient in master list for a given candidate string
      function findIngredientCandidate(candidate){
        if(!candidate) return null;
        // exact match first
        let found = ingredientMaster.find(im => cleanIngredientName(im.name) === candidate);
        if(found) return found;
        // try case where candidate contains master name or vice-versa (covers 'chicken liver' inside longer strings)
        found = ingredientMaster.find(im => {
          const m = cleanIngredientName(im.name);
          return candidate.includes(m) || m.includes(candidate);
        });
        return found || null;
      }

      // strip hydrolysed and common suffixes like 'protein', 'gravy', 'extract' to get base candidate
      const withoutHydro = raw.replace(hydroRegex, '').replace(/\b(protein|proteins|gravy|extract|powder|meal)\b/g, '').replace(/[^a-z0-9\s\-]/g,' ').replace(/\s+/g,' ').trim();

      // attempt matches in order: exact raw, without hydro, then fuzzy contains
      let ingredient = findIngredientCandidate(raw) || findIngredientCandidate(withoutHydro);

      // if still not found, try token-based matching (look for any master token inside the raw string)
      if(!ingredient){
        for(const im of ingredientMaster){
          const m = cleanIngredientName(im.name);
          if(raw.includes(m) || withoutHydro.includes(m)) { ingredient = im; break; }
        }
      }

      // If no matching ingredient found, default to safe
      if(!ingredient) return 'ok';

      const tags = ingredient.tags || [];
      // identify category matches
      const isGluten = tags.includes('gluten') || raw.includes('gluten') || withoutHydro.includes('gluten');
      const isPoultry = tags.includes('poultry') || /\b(chicken|poultry|turkey)\b/.test(raw) || /\b(chicken|poultry|turkey)\b/.test(withoutHydro);

      // If user is focusing on gluten/poultry, force danger for those categories
      if(prefs.noGluten && isGluten) return 'danger';
      if(prefs.noPoultry && isPoultry) return 'danger';

      // if hydrolysed and user treats hydrolysed as low risk -> safe
      if(hasHydro && prefs.hydro) return 'ok';

      // otherwise follow master risk level, but allow downgrade when the user has NOT focused on that category
      let baseRisk = ingredient.risk_level || 'safe';
      if(baseRisk === 'danger'){
        // downgrade poultry/gluten dangers to 'warn' if the user hasn't enabled that focus
        if((isGluten && !prefs.noGluten) || (isPoultry && !prefs.noPoultry)){
          baseRisk = 'warn';
        }
      }

      if(baseRisk === 'danger') return 'danger';
      if(baseRisk === 'warn') return 'warn';
      return 'ok';
    }

    function noteFor(name){
      const raw = cleanIngredientName(name);
      // reuse matching logic: prefer exact then without hydro
      const hydroRegex = /\bhydroly(s|z)ed\b|\bhydroly(s|z)sed\b/g;
      const withoutHydro = raw.replace(hydroRegex, '').replace(/\b(protein|proteins|gravy|extract|powder|meal)\b/g, '').replace(/[^a-z0-9\s\-]/g,' ').replace(/\s+/g,' ').trim();
      let ingredient = ingredientMaster.find(im => cleanIngredientName(im.name) === raw) || ingredientMaster.find(im => cleanIngredientName(im.name) === withoutHydro);
      if(!ingredient){
        ingredient = ingredientMaster.find(im => raw.includes(cleanIngredientName(im.name)) || withoutHydro.includes(cleanIngredientName(im.name)));
      }
      return ingredient ? ingredient.note : '';
    }

    function applyRowFilter(){
      const rows = document.querySelectorAll('#compareTable tbody tr');
      rows.forEach(r=>{
        if(currentFilter==='showAll'){ r.hidden=false; return; }
        const isAllergen = r.dataset.risk!=='ok';
        const overlap = Number(r.dataset.count||0) >= 2;
        r.hidden = (currentFilter==='allergens' && !isAllergen) || (currentFilter==='overlap' && !overlap);
      });
    }

    // Handle form submission
    document.getElementById('compare').addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      const prefs = {
        noGluten: document.getElementById('noGluten').checked,
        noPoultry: document.getElementById('noPoultry').checked,
        hydro: document.getElementById('hydrolysedLow').checked
      };

      const { triggering, safe } = collectProducts();
      if(!triggering.length){ alert('Please add at least one triggering food.'); return; }
      if(!safe.length){ alert('Please add at least one safe food.'); return; }
      
      try {
        // Show loading state
        const submitBtn = document.querySelector('#compare button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Analyzing...';
        submitBtn.disabled = true;
        
        // Prepare data for API
        const apiData = {
          triggering: triggering.map(f => ({ name: f.label, ingredients: f.list.join(', ') })),
          safe: safe.map(f => ({ name: f.label, ingredients: f.list.join(', ') }))
        };
        
        // Call comparison API
        const response = await fetch('api/compare.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(apiData)
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Comparison failed');
        }
        
  // Store triggering foods data for safe food finder
  triggeringFoodsData = triggering;
  nonSimilarIngredients = result.data.nonSimilarIngredients;

  // Store last comparison data so we can re-render when toggles change
  lastComparison = { comparisonData: result.data.comparisonTable, triggering, safe };
  
  // Enable save button if user is logged in
  if (auth.currentUser && currentDogId) {
    const saveBtn = document.getElementById('saveComparisonBtn');
    saveBtn.disabled = false;
  }

  // Build and display comparison table
  displayComparisonTable(result.data.comparisonTable, triggering, safe, prefs);
        
        // Show the safe food finder
        document.getElementById('safeFoodFinder').style.display = 'block';
        
        // Show success state for 10 seconds
        submitBtn.textContent = 'Done!';
        submitBtn.style.background = 'var(--ok)';
        submitBtn.disabled = false;
        
        // After 10 seconds, restore original button state
        setTimeout(() => {
          submitBtn.textContent = originalText;
          submitBtn.style.background = '';
        }, 10000);
        
      } catch (error) {
        console.error('Comparison failed:', error);
        alert('Comparison failed: ' + error.message);
        
        // Restore button state on error
        const submitBtn = document.querySelector('#compare button[type="submit"]');
        submitBtn.textContent = 'Build Comparison';
        submitBtn.style.background = '';
        submitBtn.disabled = false;
      }
    });

    function displayComparisonTable(comparisonData, triggering, safe, prefs) {
      const allFoods = [...triggering, ...safe];
      const tbl = document.getElementById('compareTable');
      const cols = ['Ingredient', ...allFoods.map(p=>p.label), 'Allergen note'];
      tbl.innerHTML = '<thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody></tbody>';
      const body = tbl.querySelector('tbody');

      comparisonData.forEach(rowData => {
        const name = rowData.ingredient;
        
        // presence per product
        let count = 0; 
        const cells = allFoods.map(p => {
          const hit = rowData.presence[p.label];
          if(hit) count++; 
          return `<td>${hit ? '✅' : ''}</td>`;
        });
        
        // allergen note & class
        const risk = allergenClass(name, prefs);
        const cls = risk==='danger' ? 'pill danger' : risk==='warn' ? 'pill warn' : 'pill ok';
        const note = [noteFor(name) || ''].filter(Boolean).join(' ');
        
        // non-similar indicator
        const isNonSimilar = nonSimilarIngredients.includes(name);
        
        const tableRow = document.createElement('tr');
        tableRow.className = 'hover';
        if (isNonSimilar) {
          tableRow.classList.add('non-similar');
        }
        tableRow.dataset.count = count;
        tableRow.dataset.risk = risk;
        
        // Put warning pill after the ingredient name
        const ingredientName = isNonSimilar ? 
          `<strong>${name}</strong> <span class="pill danger" style="margin-left: 8px;">⚠️ NON-SIMILAR</span>` : 
          `<strong>${name}</strong>`;
        
        tableRow.innerHTML = `<td>${ingredientName}</td>${cells.join('')}<td><span class="${cls}">${risk.toUpperCase()}</span> ${note}</td>`;
        body.append(tableRow);
      });

      document.getElementById('legend').hidden = false;
      document.getElementById('resultNote').textContent = `${comparisonData.length} unique ingredients normalised. Found ${nonSimilarIngredients.length} non-similar ingredients. Click column headers to sort (browser shortcuts).`;
      applyRowFilter();
      
      // Show safe food suggestions based on non-similar ingredients
      renderSafeFoodSuggestions(nonSimilarIngredients, comparisonData);
    }

    // Safe Food Finder functionality
    document.getElementById('testNewFood').addEventListener('click', async () => {
      const foodName = document.getElementById('newFoodName').value.trim();
      const ingredients = document.getElementById('newFoodIngredients').value.trim();
      
      if (!foodName || !ingredients) {
        alert('Please enter both food name and ingredients.');
        return;
      }
      
      if (nonSimilarIngredients.length === 0) {
        alert('Please run a comparison first to identify non-similar ingredients.');
        return;
      }
      
      try {
        // Show loading state
        const testBtn = document.getElementById('testNewFood');
        const originalText = testBtn.textContent;
        testBtn.textContent = 'Testing...';
        testBtn.disabled = true;
        
        // Call safe food finder API
        const response = await fetch('api/safe_food_finder.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            foodName: foodName,
            ingredients: ingredients,
            nonSimilarIngredients: nonSimilarIngredients
          })
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Food safety test failed');
        }
        
        // Display results
        displaySafeFoodResult(result.data);
        
        // Show success state for 10 seconds
        testBtn.textContent = 'Done!';
        testBtn.style.background = 'var(--ok)';
        testBtn.disabled = false;
        
        // After 10 seconds, restore original button state
        setTimeout(() => {
          testBtn.textContent = originalText;
          testBtn.style.background = '';
        }, 10000);
        
      } catch (error) {
        console.error('Safe food test failed:', error);
        alert('Food safety test failed: ' + error.message);
        
        // Restore button state on error
        const testBtn = document.getElementById('testNewFood');
        testBtn.textContent = originalText;
        testBtn.style.background = '';
        testBtn.disabled = false;
      }
    });

    function displaySafeFoodResult(data) {
      const resultDiv = document.getElementById('safetyResult');
      const titleEl = document.getElementById('safetyTitle');
      const detailsEl = document.getElementById('safetyDetails');
      const ingredientTableBody = document.getElementById('ingredientTableBody');
      
      if (data.problematicCount > 0) {
        titleEl.textContent = `⚠️ UNSAFE: ${data.foodName}`;
        titleEl.style.color = '#d32f2f';
        detailsEl.innerHTML = `
          <p>This food contains <strong>${data.problematicCount}</strong> ingredient(s) that caused problems for your dog:</p>
          <ul>
            ${data.problematicIngredients.map(ingredient => `<li><strong>${ingredient}</strong></li>`).join('')}
          </ul>
          <p class="muted">We recommend avoiding this food.</p>
        `;
      } else {
        titleEl.textContent = `✅ SAFE: ${data.foodName}`;
        titleEl.style.color = '#2e7d32';
        detailsEl.innerHTML = `
          <p>This food appears to be safe for your dog!</p>
          <p class="muted">No problematic ingredients were found that match your dog's known triggers.</p>
        `;
      }
      
      // Always show the ingredient analysis table
      resultDiv.style.display = 'block';
      document.getElementById('ingredientTable').style.display = 'block';
      
      // Populate the ingredient analysis table
      ingredientTableBody.innerHTML = '';
      data.ingredientAnalysis.forEach(ingredient => {
        const row = document.createElement('tr');
        const isNonSimilar = ingredient.status === 'Non-Similar';
        
        row.innerHTML = `
          <td style="padding: 12px 10px; border-bottom: 1px solid #eee;"><strong>${ingredient.ingredient}</strong></td>
          <td style="padding: 12px 10px; border-bottom: 1px solid #eee;"><span class="pill ${isNonSimilar ? 'danger' : 'ok'}">${ingredient.status}</span></td>
          <td style="padding: 12px 10px; border-bottom: 1px solid #eee;">${ingredient.similarTo}</td>
        `;
        ingredientTableBody.appendChild(row);
      });
    }

    // Utility function to show errors
    function showError(message) {
      // You can implement a proper error display system here
      console.error(message);
      alert(message);
    }

    // --- Glossary Modal ---
    const modal = document.getElementById('glossaryModal');
    const openBtns = [document.getElementById('openGlossary'), document.getElementById('openGlossary2')];
    const closeBtn = document.getElementById('closeGlossary');
    openBtns.forEach(b=>b.addEventListener('click', ()=>{ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); document.getElementById('gSearch').focus(); }));
    closeBtn.addEventListener('click', ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); });
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeBtn.click(); });

    // Populate glossary
    const gloss = document.getElementById('glossary');
    function renderGlossary(filter=''){
      gloss.innerHTML = '';
      const cleanFilter = cleanIngredientName(filter);
      ingredientMaster.filter(m => cleanIngredientName(m.name).includes(cleanFilter)).forEach(m=>{
        const card = document.createElement('div');
        card.className='gloss';
        const tag = m.tags.includes('gluten')? 'danger' : m.tags.includes('danger')? 'danger' : m.tags.includes('possible')? 'warn':'ok';
        card.innerHTML = `<h4>${m.name}</h4><p class="muted">${m.note||''}</p><span class="pill ${tag}">${tag.toUpperCase()}</span>`;
        gloss.append(card);
      });
    }
    renderGlossary();
    document.getElementById('gSearch').addEventListener('input', (e)=>renderGlossary(e.target.value));

    // year
    document.getElementById('yr').textContent = new Date().getFullYear();
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Live re-render when gluten/poultry toggles change (apply immediately to the existing table)
    document.getElementById('noGluten').addEventListener('change', ()=>{
      if(!lastComparison) return;
      const prefs = {
        noGluten: document.getElementById('noGluten').checked,
        noPoultry: document.getElementById('noPoultry').checked,
        hydro: document.getElementById('hydrolysedLow').checked
      };
      displayComparisonTable(lastComparison.comparisonData, lastComparison.triggering, lastComparison.safe, prefs);
    });

    document.getElementById('noPoultry').addEventListener('change', ()=>{
      if(!lastComparison) return;
      const prefs = {
        noGluten: document.getElementById('noGluten').checked,
        noPoultry: document.getElementById('noPoultry').checked,
        hydro: document.getElementById('hydrolysedLow').checked
      };
      displayComparisonTable(lastComparison.comparisonData, lastComparison.triggering, lastComparison.safe, prefs);
    });

    document.getElementById('loadLastBtn').addEventListener('click', async () => {
      if(!currentDogId){ alert('Please select a dog.'); return; }
      if(!auth || !auth.currentUser){ alert('Sign in to load saved comparisons.'); return; }
      try {
        const data = await loadLastComparisonFromFirestore(currentDogId);
        if(!data){ alert('No saved comparison found for this dog. Build one first or sign in with a different dog.'); return; }
        // Rehydrate UI using the saved data
        lastComparison = data;
        displayComparisonTable(data.comparisonTable, data.triggering, data.safe, {});
      } catch (e) {
        console.error(e);
        alert('Failed to load last comparison.');
      }
    });
  </script>

  <script>
    // Consolidated Firebase initialization and auth management
    (async function() {
      // Load Firebase config from git-ignored file if present
      try {
        const resp = await fetch('config/firebase.config.js', { cache: 'no-store' });
        if (resp.ok) {
          const text = await resp.text();
          new Function(text)();
        }
      } catch (e) {
        console.warn('Could not load Firebase config, using defaults');
      }

      const cfg = window.__firebaseConfig || {
        apiKey: 'YOUR_API_KEY',
        authDomain: 'YOUR_AUTH_DOMAIN',
        projectId: 'YOUR_PROJECT_ID',
        storageBucket: 'YOUR_STORAGE_BUCKET',
        messagingSenderId: 'YOUR_MESSAGING_SENDER_ID',
        appId: 'YOUR_APP_ID'
      };

      // Wait for Firebase to load
      while (typeof firebase === 'undefined') {
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Initialize Firebase
      const app = firebase.apps.length ? firebase.apps[0] : firebase.initializeApp(cfg);
      auth = firebase.auth();
      db = firebase.firestore();

      // Auth state listener
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          gisUser = { name: user.displayName || user.email, avatar: user.photoURL || '' };
          await loadUserData(user.uid);
          updateAuthUI(true);
        } else {
          gisUser = null;
          currentDogId = null;
          userDogs = [];
          updateAuthUI(false);
        }
      });

      // Handle redirect result (for when popup is blocked)
      auth.getRedirectResult().then((result) => {
        if (result.credential) {
          console.log('Redirect sign-in successful:', result);
          // Close both dialogs
          document.getElementById('loginDialog').style.display = 'none';
          document.getElementById('saveComparisonDialog').style.display = 'none';
        }
      }).catch((error) => {
        console.error('Redirect sign-in error:', error);
      });

      // Initialize UI event listeners
      initializeAuthUI();
    })();

    // Auth UI management
    function updateAuthUI(isLoggedIn) {
      const loginBtn = document.getElementById('loginBtn');
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      const userAvatar = document.getElementById('userAvatar');
      const userInitials = document.getElementById('userInitials');
      const noDogsMessage = document.getElementById('noDogsMessage');
      const dogManagement = document.getElementById('dogManagement');
      const dogSelectorSection = document.getElementById('dogSelectorSection');

      if (isLoggedIn) {
        loginBtn.style.display = 'none';
        userInfo.style.display = 'flex';
        
        // Update user name with proper truncation
        const displayName = gisUser.name || 'User';
        userName.textContent = displayName;
        
        // Handle profile picture or initials
        if (gisUser.avatar) {
          userAvatar.src = gisUser.avatar;
          userAvatar.style.display = 'block';
          userInitials.style.display = 'none';
        } else {
          userAvatar.style.display = 'none';
          userInitials.style.display = 'flex';
          // Generate initials from name
          const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2);
          userInitials.textContent = initials;
        }
        
        if (userDogs.length === 0) {
          noDogsMessage.style.display = 'block';
          dogManagement.style.display = 'none';
          dogSelectorSection.style.display = 'none';
          document.getElementById('currentDogIndicator').style.display = 'none';
          // Show welcome dialog for first-time users
          showWelcomeDialog();
        } else {
          noDogsMessage.style.display = 'none';
          dogManagement.style.display = 'block';
          dogSelectorSection.style.display = 'block';
          document.getElementById('currentDogIndicator').style.display = 'flex';
          renderDogSelector();
          
          // Enable save button when user has dogs
          const saveBtn = document.getElementById('saveComparisonBtn');
          saveBtn.disabled = false;
        }
      } else {
        loginBtn.style.display = 'inline-block';
        userInfo.style.display = 'none';
        noDogsMessage.style.display = 'none';
        dogManagement.style.display = 'none';
        dogSelectorSection.style.display = 'none';
        document.getElementById('currentDogIndicator').style.display = 'none';
        
        // Disable save button when user logs out
        const saveBtn = document.getElementById('saveComparisonBtn');
        saveBtn.disabled = true;
      }
    }

    function initializeAuthUI() {
      // Login button - direct login dialog
      document.getElementById('loginBtn').addEventListener('click', () => {
        document.getElementById('loginDialog').style.display = 'flex';
        initializeGoogleSignIn('googleSignInButton');
      });

      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut();
      });

      // Profile click handler to toggle dropdown
      document.addEventListener('click', (e) => {
        const userProfile = document.getElementById('userProfile');
        const profileDropdown = document.querySelector('.profile-dropdown');
        
        if (userProfile && userProfile.contains(e.target)) {
          // Clicked on profile, toggle dropdown
          const isVisible = profileDropdown.style.opacity === '1';
          if (isVisible) {
            profileDropdown.style.opacity = '0';
            profileDropdown.style.visibility = 'hidden';
            profileDropdown.style.transform = 'translateY(-10px)';
          } else {
            profileDropdown.style.opacity = '1';
            profileDropdown.style.visibility = 'visible';
            profileDropdown.style.transform = 'translateY(0)';
          }
        } else if (userProfile && !userProfile.contains(e.target)) {
          // Clicked outside, close dropdown
          profileDropdown.style.opacity = '0';
          profileDropdown.style.visibility = 'hidden';
          profileDropdown.style.transform = 'translateY(-10px)';
        }
      });

      // Close dialogs
      document.getElementById('closeLoginDialog').addEventListener('click', () => {
        document.getElementById('loginDialog').style.display = 'none';
      });

      document.getElementById('closeSaveComparisonDialog').addEventListener('click', () => {
        document.getElementById('saveComparisonDialog').style.display = 'none';
      });

      document.getElementById('closeWelcomeDialog').addEventListener('click', () => {
        document.getElementById('welcomeDialog').style.display = 'none';
      });

      // Add dog button
      document.getElementById('addDogBtn').addEventListener('click', addDog);

      // Create first dog button
      document.getElementById('createFirstDog').addEventListener('click', () => {
        showWelcomeDialog();
      });

      // Welcome dialog buttons
      document.getElementById('createFirstDogFromWelcome').addEventListener('click', createFirstDogFromWelcome);
      document.getElementById('skipWelcome').addEventListener('click', () => {
        document.getElementById('welcomeDialog').style.display = 'none';
      });

      // Add new dog button
      document.getElementById('addNewDog').addEventListener('click', () => {
        showAddDogDialog();
      });

      // Dog selector dropdown
      document.getElementById('dogSelectDropdown').addEventListener('change', async (e) => {
        if (e.target.value) {
          currentDogId = e.target.value;
          
          // Show loading feedback
          showDogLoadingFeedback();
          
          // Update the dog name display immediately
          renderDogSelector();
          
          // Load the comparison
          await loadLastComparison(currentDogId);
          
          // Show success feedback
          showDogLoadedFeedback();
        }
      });

      // Save Comparison button
      document.getElementById('saveComparisonBtn').addEventListener('click', async () => {
        if (!auth.currentUser || !currentDogId) {
          alert('Please sign in and select a dog to save comparisons');
          return;
        }

        const saveBtn = document.getElementById('saveComparisonBtn');
        const originalSaveText = saveBtn.textContent;
        
        // Show saving feedback
        saveBtn.textContent = '💾 Saving...';
        saveBtn.disabled = true;
        
        try {
          // Always build fresh comparison data from current form state
          const prefs = {
            noGluten: document.getElementById('noGluten').checked,
            noPoultry: document.getElementById('noPoultry').checked,
            hydro: document.getElementById('hydrolysedLow').checked
          };

          const { triggering, safe } = collectProducts();
          console.log('Save button - collected products:', { triggering, safe });
          
          if(!triggering.length){ 
            alert('Please add at least one triggering food.'); 
            saveBtn.textContent = originalSaveText;
            saveBtn.disabled = false;
            return; 
          }
          if(!safe.length){ 
            alert('Please add at least one safe food.'); 
            saveBtn.textContent = originalSaveText;
            saveBtn.disabled = false;
            return; 
          }
          
          // Prepare data for API
          const apiData = {
            triggering: triggering.map(f => ({ name: f.label, ingredients: f.list.join(', ') })),
            safe: safe.map(f => ({ name: f.label, ingredients: f.list.join(', ') }))
          };
          
          // Call comparison API
          const response = await fetch('api/compare.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(apiData)
          });
          
          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.message || 'Comparison failed');
          }
          
          // Store the comparison data for future use
          lastComparison = { comparisonData: result.data.comparisonTable, triggering, safe };
          
          // Save to Firestore with fresh data
          console.log('Save button - saving to Firestore:', { currentDogId, triggering, safe });
          const saveResult = await saveComparisonToFirestore(currentDogId, {
            triggering,
            safe,
            comparisonTable: result.data.comparisonTable,
            timestamp: Date.now()
          });
          console.log('Save button - save result:', saveResult);
          
          // Display the comparison table
          displayComparisonTable(result.data.comparisonTable, triggering, safe, prefs);
          
          // Show success feedback
          saveBtn.textContent = '✅ Saved!';
          saveBtn.style.background = 'var(--primary)';
          saveBtn.style.color = 'white';
          
          // Reset after 2 seconds
          setTimeout(() => {
            saveBtn.textContent = originalSaveText;
            saveBtn.style.background = '';
            saveBtn.style.color = '';
            saveBtn.disabled = false;
          }, 2000);
        } catch (error) {
          console.error('Save error:', error);
          // Show error feedback
          saveBtn.textContent = '❌ Save Failed';
          saveBtn.style.background = '#dc3545';
          saveBtn.style.color = 'white';
          
          // Reset after 3 seconds
          setTimeout(() => {
            saveBtn.textContent = originalSaveText;
            saveBtn.style.background = '';
            saveBtn.style.color = '';
            saveBtn.disabled = false;
          }, 3000);
        }
      });

      // Close dialogs when clicking outside
      document.getElementById('loginDialog').addEventListener('click', (e) => {
        if (e.target.id === 'loginDialog') {
          document.getElementById('loginDialog').style.display = 'none';
        }
      });

      document.getElementById('saveComparisonDialog').addEventListener('click', (e) => {
        if (e.target.id === 'saveComparisonDialog') {
          document.getElementById('saveComparisonDialog').style.display = 'none';
        }
      });

      document.getElementById('welcomeDialog').addEventListener('click', (e) => {
        if (e.target.id === 'welcomeDialog') {
          document.getElementById('welcomeDialog').style.display = 'none';
        }
      });

      // Wire save comparison trigger
      wireSaveComparisonTrigger();
    }

    function initializeGoogleSignIn(buttonId = 'googleSignInButton') {
      // Create a simple Google Sign-In button that uses Firebase Auth directly
      const buttonContainer = document.getElementById(buttonId);
      if (!buttonContainer) return;

      buttonContainer.innerHTML = `
        <button id="firebaseGoogleSignIn" style="
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 12px;
          padding: 12px 24px;
          border: 1px solid #dadce0;
          border-radius: 8px;
          background: white;
          color: #3c4043;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s;
          width: 100%;
          max-width: 300px;
        ">
          <svg width="18" height="18" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </button>
      `;

      // Add click handler for Firebase Google Sign-In
      document.getElementById('firebaseGoogleSignIn').addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        
        // Try popup first, fallback to redirect if blocked
        auth.signInWithPopup(provider).then((result) => {
          console.log('Sign-in successful:', result);
          // Close both dialogs
          document.getElementById('loginDialog').style.display = 'none';
          document.getElementById('saveComparisonDialog').style.display = 'none';
        }).catch((error) => {
          console.error('Sign-in error details:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);
          
          // If popup is blocked, try redirect
          if (error.code === 'auth/popup-blocked') {
            console.log('Popup blocked, trying redirect...');
            auth.signInWithRedirect(provider);
            return;
          }
          
          // More specific error messages
          let errorMessage = 'Sign-in failed. Please try again.';
          if (error.code === 'auth/popup-closed-by-user') {
            errorMessage = 'Sign-in was cancelled. Please try again.';
          } else if (error.code === 'auth/unauthorized-domain') {
            errorMessage = 'Domain not authorized. Please check Firebase configuration.';
          } else if (error.code === 'auth/operation-not-allowed') {
            errorMessage = 'Google Sign-In is not enabled. Please check Firebase configuration.';
          }
          
          showError(errorMessage);
        });
      });
    }

    function wireSaveComparisonTrigger() {
      // Find the form submission or save button and add the trigger
      const compareForm = document.getElementById('compare');
      if (compareForm) {
        compareForm.addEventListener('submit', (e) => {
          // Check if user is logged in before allowing save
          if (!auth.currentUser) {
            e.preventDefault();
            document.getElementById('saveComparisonDialog').style.display = 'flex';
            initializeGoogleSignIn('saveComparisonGoogleSignInButton');
            return false;
          }
        });
      }
    }


    async function loadUserData(userId) {
      try {
        // Load user's dogs
        const dogsSnapshot = await db.collection('users').doc(userId).collection('dogs').get();
        userDogs = [];
        dogsSnapshot.forEach(doc => {
          userDogs.push({ id: doc.id, ...doc.data() });
        });

        // Select first dog if available
        if (userDogs.length > 0) {
          currentDogId = userDogs[0].id;
          await loadLastComparison(currentDogId);
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showError('Failed to load your data. Please try again.');
      }
    }

    function renderDogSelector() {
      const dogSelectDropdown = document.getElementById('dogSelectDropdown');
      const currentDogName = document.getElementById('currentDogName');
      const indicatorDogName = document.getElementById('indicatorDogName');
      
      dogSelectDropdown.innerHTML = '<option value="">Select a dog...</option>' + 
        userDogs.map(dog => `<option value="${dog.id}" ${dog.id === currentDogId ? 'selected' : ''}>${dog.name}</option>`).join('');
      
      // Update the current dog name display
      if (currentDogId) {
        const currentDog = userDogs.find(dog => dog.id === currentDogId);
        if (currentDog) {
          currentDogName.textContent = currentDog.name;
          indicatorDogName.textContent = currentDog.name;
        }
      } else {
        currentDogName.textContent = 'your dog';
        indicatorDogName.textContent = 'your dog';
      }
    }

    function showWelcomeDialog() {
      document.getElementById('welcomeDialog').style.display = 'flex';
      document.getElementById('firstDogName').focus();
    }

    function showAddDogDialog() {
      const dogName = prompt('Enter your dog\'s name:');
      if (dogName && dogName.trim()) {
        createDog(dogName.trim());
      }
    }

    async function createFirstDogFromWelcome() {
      const dogName = document.getElementById('firstDogName').value.trim();
      if (!dogName) {
        alert('Please enter a dog name');
        return;
      }
      
      await createDog(dogName);
      document.getElementById('welcomeDialog').style.display = 'none';
      document.getElementById('firstDogName').value = '';
    }

    async function createDog(dogName) {
      if (!auth.currentUser) {
        alert('Please sign in first');
        return;
      }

      try {
        const dogData = {
          name: dogName,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const docRef = await db.collection('users').doc(auth.currentUser.uid).collection('dogs').add(dogData);
        userDogs.push({ id: docRef.id, ...dogData });
        currentDogId = docRef.id;
        
        updateAuthUI(true);
        showSuccess('Dog profile created successfully!');
      } catch (error) {
        console.error('Error adding dog:', error);
        showError('Failed to add dog. Please try again.');
      }
    }

    function showDogLoadingFeedback() {
      const dogSelectorCard = document.querySelector('.dog-selector-card');
      const currentDogName = document.getElementById('currentDogName');
      
      // Add loading animation
      dogSelectorCard.style.opacity = '0.7';
      dogSelectorCard.style.transform = 'scale(0.98)';
      currentDogName.innerHTML = '<span style="display: inline-block; animation: pulse 1s infinite;">⏳</span> Loading...';
      
      // Add pulse animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `;
      document.head.appendChild(style);
    }

    function showDogLoadedFeedback() {
      const dogSelectorCard = document.querySelector('.dog-selector-card');
      const currentDogName = document.getElementById('currentDogName');
      
      // Remove loading state
      dogSelectorCard.style.opacity = '1';
      dogSelectorCard.style.transform = 'scale(1)';
      
      // Show success feedback
      const originalName = currentDogName.textContent;
      currentDogName.innerHTML = '<span style="color: var(--primary);">✅</span> ' + originalName;
      
      // Reset after 2 seconds
      setTimeout(() => {
        currentDogName.textContent = originalName;
      }, 2000);
    }

    async function addDog() {
      const dogName = document.getElementById('newDogName').value.trim();
      if (!dogName) {
        alert('Please enter a dog name');
        return;
      }

      await createDog(dogName);
      document.getElementById('newDogName').value = '';
    }

    async function loadLastComparison(dogId) {
      if (!dogId) return;

      try {
        const comparisonsSnapshot = await db.collection('users').doc(auth.currentUser.uid)
          .collection('dogs').doc(dogId).collection('comparisons')
          .orderBy('timestamp', 'desc').limit(1).get();

        if (!comparisonsSnapshot.empty) {
          const comparison = comparisonsSnapshot.docs[0].data();
          // Render the comparison in the UI
          renderComparison(comparison);
          
          // Show success feedback in the indicator
          const indicatorDogName = document.getElementById('indicatorDogName');
          const originalText = indicatorDogName.textContent;
          indicatorDogName.innerHTML = '<span style="color: var(--primary);">✅</span> ' + originalText;
          
          setTimeout(() => {
            indicatorDogName.textContent = originalText;
          }, 2000);
        } else {
          // Show no data message in the indicator
          const indicatorDogName = document.getElementById('indicatorDogName');
          const originalText = indicatorDogName.textContent;
          indicatorDogName.innerHTML = '<span style="color: var(--muted);">📝</span> ' + originalText + ' (no saved data)';
          
          setTimeout(() => {
            indicatorDogName.textContent = originalText;
          }, 3000);
        }
      } catch (error) {
        console.error('Error loading last comparison:', error);
        showError('Failed to load comparison. Please try again.');
      }
    }

    function renderComparison(comparison) {
      console.log('Loading comparison:', comparison);
      
      // Populate the form fields with the saved comparison data
      if (comparison.triggering && comparison.triggering.length > 0) {
        // Clear existing triggering foods
        const triggeringContainer = document.getElementById('triggeringFoods');
        if (triggeringContainer) {
          // Remove all existing food entries except the first one
          const existingEntries = triggeringContainer.querySelectorAll('.foodEntry:not(:first-child)');
          existingEntries.forEach(entry => entry.remove());
          
          // Populate the first entry
          const firstEntry = triggeringContainer.querySelector('.foodEntry:first-child');
          if (firstEntry) {
            const foodSelect = firstEntry.querySelector('select');
            const ingredientsTextarea = firstEntry.querySelector('textarea');
            
            if (foodSelect && ingredientsTextarea) {
              // Extract the food name from the label (remove "Triggering: " prefix)
              const foodName = comparison.triggering[0].label.replace('Triggering: ', '');
              // Convert list array back to comma-separated string
              const ingredients = comparison.triggering[0].list.join(', ');
              
              // Find the full option value that matches this food name
              const matchingOption = Array.from(foodSelect.options).find(option => 
                option.value.includes(foodName) || option.textContent.includes(foodName)
              );
              
              if (matchingOption) {
                foodSelect.value = matchingOption.value;
              } else {
                // If no exact match, set to custom and populate ingredients
                foodSelect.value = 'Custom (paste)';
              }
              ingredientsTextarea.value = ingredients;
            }
          }
          
          // Add additional triggering foods if there are more
          for (let i = 1; i < comparison.triggering.length; i++) {
            addNewFood('triggeringFoods');
            const newEntry = triggeringContainer.querySelector('.foodEntry:last-child');
            if (newEntry) {
              const foodSelect = newEntry.querySelector('select');
              const ingredientsTextarea = newEntry.querySelector('textarea');
              if (foodSelect && ingredientsTextarea) {
                const foodName = comparison.triggering[i].label.replace('Triggering: ', '');
                const ingredients = comparison.triggering[i].list.join(', ');
                
                // Find the full option value that matches this food name
                const matchingOption = Array.from(foodSelect.options).find(option => 
                  option.value.includes(foodName) || option.textContent.includes(foodName)
                );
                
                if (matchingOption) {
                  foodSelect.value = matchingOption.value;
                } else {
                  // If no exact match, set to custom and populate ingredients
                  foodSelect.value = 'Custom (paste)';
                }
                ingredientsTextarea.value = ingredients;
              }
            }
          }
        }
      }
      
      if (comparison.safe && comparison.safe.length > 0) {
        // Clear existing safe foods
        const safeContainer = document.getElementById('safeFoods');
        if (safeContainer) {
          // Remove all existing food entries except the first one
          const existingEntries = safeContainer.querySelectorAll('.foodEntry:not(:first-child)');
          existingEntries.forEach(entry => entry.remove());
          
          // Populate the first entry
          const firstEntry = safeContainer.querySelector('.foodEntry:first-child');
          if (firstEntry) {
            const foodSelect = firstEntry.querySelector('select');
            const ingredientsTextarea = firstEntry.querySelector('textarea');
            
            if (foodSelect && ingredientsTextarea) {
              const foodName = comparison.safe[0].label.replace('Safe: ', '');
              const ingredients = comparison.safe[0].list.join(', ');
              
              // Find the full option value that matches this food name
              const matchingOption = Array.from(foodSelect.options).find(option => 
                option.value.includes(foodName) || option.textContent.includes(foodName)
              );
              
              if (matchingOption) {
                foodSelect.value = matchingOption.value;
              } else {
                // If no exact match, set to custom and populate ingredients
                foodSelect.value = 'Custom (paste)';
              }
              ingredientsTextarea.value = ingredients;
            }
          }
          
          // Add additional safe foods if there are more
          for (let i = 1; i < comparison.safe.length; i++) {
            addNewFood('safeFoods');
            const newEntry = safeContainer.querySelector('.foodEntry:last-child');
            if (newEntry) {
              const foodSelect = newEntry.querySelector('select');
              const ingredientsTextarea = newEntry.querySelector('textarea');
              if (foodSelect && ingredientsTextarea) {
                const foodName = comparison.safe[i].label.replace('Safe: ', '');
                const ingredients = comparison.safe[i].list.join(', ');
                
                // Find the full option value that matches this food name
                const matchingOption = Array.from(foodSelect.options).find(option => 
                  option.value.includes(foodName) || option.textContent.includes(foodName)
                );
                
                if (matchingOption) {
                  foodSelect.value = matchingOption.value;
                } else {
                  // If no exact match, set to custom and populate ingredients
                  foodSelect.value = 'Custom (paste)';
                }
                ingredientsTextarea.value = ingredients;
              }
            }
          }
        }
      }
    }

    // Safe Food Suggestions - Using real food catalog data
    const safeFoodProducts = [
      {
        id: 'royal-canin-maxi-adult',
        name: 'Royal Canin MAXI Adult 5+ Large breed',
        brand: 'Royal Canin',
        asin: 'B00CNVBCLA',
        ingredients: 'dehydrated poultry proteins, animal fats, maize, wheat meal, wheat flour, barley, maize gluten, wheat gluten, hydrolysed animal proteins, beet pulp, minerals, fish oil, soya oil, yeast products, psyllium husks and seeds, fructo-oligosaccharides, algal oil (schizochytrium), glucosamine, hydrolysed cartilage'
      },
      {
        id: 'hills-science-diet-chicken-barley',
        name: 'Hill\'s Science Diet Adult Chicken & Barley Recipe',
        brand: 'Hill\'s Science Diet',
        asin: 'B07L5FF4W3',
        ingredients: 'chicken, brown rice, oats, maize, egg, pea, pea protein, natural flavor, corn gluten meal, linseed, chicken fat, beet pulp, minerals'
      },
      {
        id: 'orijen-original',
        name: 'Orijen Original',
        brand: 'Orijen',
        asin: 'B01I3K10ZC',
        ingredients: 'fresh chicken, fresh turkey, fresh eggs, fresh chicken liver, whole herring, whole flounder, turkey liver, chicken necks, chicken heart, turkey heart, dehydrated chicken, dehydrated turkey, dehydrated mackerel, dehydrated sardine, dehydrated herring, red lentils, green lentils, green peas, lentil fibre, chickpeas, yellow peas, pinto beans, navy beans, herring oil, chicken fat, chicken cartilage, freeze-dried chicken liver, freeze-dried turkey liver, pumpkin, butternut squash, zucchini, parsnips, carrots, apples, pears, kale, spinach, beet greens, turnip greens, kelp, cranberries, blueberries, saskatoon berries, chicory root, turmeric, milk thistle, burdock root, lavender, marshmallow root, rosehips, minerals'
      },
      {
        id: 'blue-buffalo-life-protection',
        name: 'Blue Buffalo Life Protection Adult Chicken & Brown Rice',
        brand: 'Blue Buffalo',
        asin: null, // No ASIN in database
        ingredients: 'deboned chicken, chicken meal, brown rice, oatmeal, barley, pea, chicken fat (mixed tocopherols), dried tomato pomace, natural flavor, pea protein, linseed, salt, alfalfa, pea fiber, calcium carbonate, potassium chloride, DL-methionine, carrots, blueberries, cranberries, kelp, parsley, turmeric, yeast, glucosamine, taurine, L-carnitine, vitamins and minerals'
      },
      {
        id: 'wellness-complete-health',
        name: 'Wellness Complete Health Adult Deboned Chicken & Oatmeal',
        brand: 'Wellness',
        asin: null, // No ASIN in database
        ingredients: 'deboned chicken, chicken meal, oatmeal, barley, brown rice, pea, beet pulp, chicken fat, linseed, natural flavor, chicory root, taurine, spinach, broccoli, carrots, parsley, apples, blueberries, kale, mixed tocopherols, glucosamine, yucca schidigera, probiotics, minerals'
      },
      {
        id: 'canagan-free-range-chicken',
        name: 'Canagan Free-Range Chicken',
        brand: 'Canagan',
        asin: null, // No ASIN in database
        ingredients: 'freshly prepared free-range chicken, dried chicken, sweet potato, pea, potato, chicken fat, alfalfa, dried egg, chicken gravy, salmon oil, minerals, glucosamine, MSM, apple, carrot, spinach, psyllium, seaweed, fructo-oligosaccharides, chondroitin, camomile, peppermint, marigold, cranberry, aniseed, fenugreek'
      }
    ];

    // Function to generate Amazon affiliate link
    function generateAffiliateLink(product) {
      if (product.asin) {
        // Product has ASIN - direct product link
        return `https://www.amazon.com/dp/${product.asin}?tag=allergenfreed-20&linkCode=ur2&camp=2474&creative=9325`;
      } else {
        // No ASIN - search link with product name
        const searchQuery = encodeURIComponent(`${product.brand} ${product.name}`);
        return `https://www.amazon.com/s?k=${searchQuery}&tag=allergenfreed-20&linkCode=ur2&camp=2474&creative=9325`;
      }
    }

    // Function to fetch Amazon product image using our PHP proxy
    async function fetchAmazonImage(asin) {
      try {
        // Use our PHP proxy to fetch Amazon images
        const response = await fetch(`api/amazon_images.php?asin=${asin}`);
        const data = await response.json();
        
        if (data.success && data.image) {
          return data.image;
        }
        return null;
      } catch (error) {
        console.log('Amazon image fetch error:', error);
        return null;
      }
    }

    // Function to load Amazon product image with fallback
    async function loadAmazonImage(img, product) {
      const asin = product.asin;
      if (!asin) {
        img.style.display = 'none';
        img.nextElementSibling.style.display = 'flex';
        return;
      }

      // Show loading state
      img.style.display = 'none';
      img.nextElementSibling.style.display = 'flex';
      img.nextElementSibling.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
          <div style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <span style="font-size: 12px; margin-top: 8px;">Loading...</span>
        </div>
      `;

      try {
        // Try to fetch the Amazon image
        const imageUrl = await fetchAmazonImage(asin);
        
        if (imageUrl) {
          // Amazon image found, load it
          img.src = imageUrl;
          img.style.display = 'block';
          img.nextElementSibling.style.display = 'none';
        } else {
          // No Amazon image, show branded fallback
          showBrandedFallback(img, product);
        }
      } catch (error) {
        console.log('Error loading Amazon image:', error);
        showBrandedFallback(img, product);
      }
    }

    // Function to show branded fallback
    function showBrandedFallback(img, product) {
      img.style.display = 'none';
      img.nextElementSibling.style.display = 'flex';
      img.nextElementSibling.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, ${getProductColor(product)}, ${getProductColor(product, true)}); color: white; font-size: 48px; flex-direction: column;">
          <span>🐕</span>
          <span style="font-size: 12px; margin-top: 8px; text-align: center; padding: 0 8px;">${product.brand}</span>
        </div>
      `;
    }

    // Function to get product color for fallback display
    function getProductColor(product, isSecondary = false) {
      const productHash = product.name.split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
      }, 0);
      
      const colors = [
        ['#ff6b6b', '#ff8e8e'],
        ['#4ecdc4', '#6dd5d0'],
        ['#45b7d1', '#6bc5d8'],
        ['#96ceb4', '#a8d4c1'],
        ['#feca57', '#fed766'],
        ['#ff9ff3', '#ffb3f7']
      ];
      
      const colorIndex = Math.abs(productHash) % colors.length;
      return colors[colorIndex][isSecondary ? 1 : 0];
    }

    // Function to get fallback image URL for products without ASIN
    function getFallbackImageUrl(product) {
      // Return a simple placeholder that will be replaced by the div fallback
      return 'data:image/svg+xml,<svg width="1" height="1" xmlns="http://www.w3.org/2000/svg"></svg>';
    }

    // Function to find safe food suggestions based on problematic non-overlapping ingredients
    function findSafeFoodSuggestions(nonOverlappingIngredients, comparisonData) {
      if (!nonOverlappingIngredients || nonOverlappingIngredients.length === 0) {
        return safeFoodProducts.slice(0, 6); // Return all products if no problematic ingredients
      }

      // Filter to only get problematic ingredients (danger and warn risk levels)
      const problematicIngredients = nonOverlappingIngredients.filter(ingredientName => {
        // Find the ingredient in comparison data to get its risk level
        const ingredientData = comparisonData.find(item => item.name === ingredientName);
        if (!ingredientData) return false;
        
        // Only consider ingredients with danger or warn risk levels
        return ingredientData.risk === 'danger' || ingredientData.risk === 'warn';
      });

      // If no problematic ingredients, return all products
      if (problematicIngredients.length === 0) {
        return safeFoodProducts.slice(0, 6);
      }

      const safeProducts = safeFoodProducts.filter(product => {
        // Parse ingredients string into array
        const productIngredients = product.ingredients.toLowerCase().split(/[,\s]+/).map(ing => ing.trim()).filter(ing => ing.length > 0);
        
        // Check if product doesn't contain any of the problematic ingredients
        return !productIngredients.some(ingredient => 
          problematicIngredients.some(problemIngredient => 
            ingredient.includes(problemIngredient.toLowerCase()) ||
            problemIngredient.toLowerCase().includes(ingredient)
          )
        );
      });

      // Return only truly safe products - NO FALLBACKS to unsafe foods
      return safeProducts;
    }

    // Function to render safe food suggestions
    function renderSafeFoodSuggestions(nonOverlappingIngredients, comparisonData) {
      const suggestionsSection = document.getElementById('safeFoodSuggestions');
      const suggestionsGrid = document.getElementById('suggestionsGrid');
      
      if (!suggestionsSection || !suggestionsGrid) return;

      const safeProducts = findSafeFoodSuggestions(nonOverlappingIngredients, comparisonData);
      
      if (safeProducts.length === 0) {
        suggestionsSection.style.display = 'none';
        return;
      }

      suggestionsGrid.innerHTML = safeProducts.map(product => `
        <a href="${generateAffiliateLink(product)}" target="_blank" rel="noopener noreferrer" class="product-card">
          <div class="product-image">
            <img alt="${product.name}" 
                 style="width: 100%; height: 100%; object-fit: cover;">
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, ${getProductColor(product)}, ${getProductColor(product, true)}); color: white; font-size: 48px; flex-direction: column;">
              <span>🐕</span>
              <span style="font-size: 12px; margin-top: 8px; text-align: center; padding: 0 8px;">${product.brand}</span>
            </div>
          </div>
          <div class="product-info">
            <h3 class="product-name">${product.name}</h3>
            <div class="product-brand" style="color: var(--muted); font-size: 12px; margin-bottom: 8px;">${product.brand}</div>
            <div class="affiliate-badge">${product.asin ? 'Amazon Product' : 'Amazon Search'}</div>
          </div>
        </a>
      `).join('');

      // Load Amazon images for products with ASINs
      safeProducts.forEach(async (product, index) => {
        const productCard = suggestionsGrid.children[index];
        const img = productCard.querySelector('img');
        const fallback = productCard.querySelector('.product-image > div');
        
        if (product.asin) {
          // Try to load Amazon image
          await loadAmazonImage(img, product);
        } else {
          // No ASIN, show fallback immediately
          img.style.display = 'none';
          fallback.style.display = 'flex';
        }
      });

      suggestionsSection.style.display = 'block';
    }

    // Firestore functions for saving/loading comparisons
    async function saveComparisonToFirestore(dogId, data) {
      if (!auth.currentUser || !dogId) return false;

      try {
        await db.collection('users').doc(auth.currentUser.uid)
          .collection('dogs').doc(dogId).collection('comparisons').add({
            ...data,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        return true;
      } catch (error) {
        console.error('Error saving comparison:', error);
        return false;
      }
    }

    async function loadLastComparisonFromFirestore(dogId) {
      if (!auth.currentUser || !dogId) return null;

      try {
        const snapshot = await db.collection('users').doc(auth.currentUser.uid)
          .collection('dogs').doc(dogId).collection('comparisons')
          .orderBy('timestamp', 'desc').limit(1).get();
        
        return snapshot.empty ? null : snapshot.docs[0].data();
      } catch (error) {
        console.error('Error loading comparison:', error);
        return null;
      }
    }

    async function loadUserDogsFromFirestore(userId) {
      if (!userId) return [];

      try {
        const snapshot = await db.collection('users').doc(userId).collection('dogs').get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error loading dogs:', error);
        return [];
      }
    }

    // Utility functions
    function showError(message) {
      // You can implement a toast notification system here
      alert('Error: ' + message);
    }

    function showSuccess(message) {
      // You can implement a toast notification system here
      alert('Success: ' + message);
    }

    // Expose functions globally for compatibility
    window.saveComparisonToFirestore = saveComparisonToFirestore;
    window.loadLastComparisonFromFirestore = loadLastComparisonFromFirestore;
    window.loadUserDogsFromFirestore = loadUserDogsFromFirestore;
  </script>
</body>
</html>
