<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Basic SEO -->
  <title>Allergy Free Dog — Compare Dog Foods & Find Allergens</title>
  <meta name="description" content="Allergy Free Dog helps dog owners compare ingredients between triggering and safe foods to detect possible allergens like gluten, poultry, soy, peas, and fish.">
  <meta name="keywords" content="dog food allergy, dog food comparison, gluten free dog food, chicken free dog food, dog food allergens, dog nutrition, pet health">
  <meta name="author" content="Allergy Free Dog Team">

  <!-- Open Graph (Facebook, LinkedIn) -->
  <meta property="og:title" content="Allergy Free Dog — Compare Dog Foods & Find Allergens">
  <meta property="og:description" content="Easily compare triggering vs safe foods to find potential allergens in your dog's diet. Works online, free, no signup.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://allergenfreedog.com">
  <meta property="og:image" content="https://allergenfreedog.com/preview-image.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Allergy Free Dog — Compare Dog Foods & Find Allergens">
  <meta name="twitter:description" content="Compare dog foods and spot allergens instantly. Free tool for pet owners.">
  <meta name="twitter:image" content="https://allergenfreedog.com/preview-image.png">

  <!-- Mobile + Theme -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#79C99E">
  
  <style>
    :root{
      --bg:#fbf6ef;           /* soft beige */
      --ink:#274642;          /* dark green-ink */
      --muted:#5a7d75;        
      --primary:#79C99E;      /* soft green */
      --accent:#FF9F68;       /* warm orange */
      --card:#ffffff;         /* cards */
      --ok:#85d1a0;
      --warn:#ffd27a;
      --danger:#ffb0a3;
      --ring: 0 0 0 3px rgb(121 201 158 / .35);
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    a{color:inherit}
    .container{max-width:1100px;margin-inline:auto;padding:24px}
    header{position:sticky;top:0;background:var(--bg)/.8;backdrop-filter:blur(8px);border-bottom:1px solid #e9e1d7;z-index:5}
    .nav{display:flex;align-items:center;gap:16px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;font-size:1.25rem;color:var(--ink)}
    .brand svg{width:28px;height:28px}
    .nav .actions{display:flex;gap:8px}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:400;cursor:pointer;transition:.2s;display:inline-flex;gap:8px;align-items:center}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:2px solid #c6dacd;color:var(--muted)}
    .btn.primary:hover{transform:translateY(-1px);filter:saturate(1.1)}
    .btn.ghost:hover{border-color:var(--primary);color:var(--ink)}
    
    /* Remove underlines from button links */
    .btn{text-decoration:none}
    
    /* Header navigation button consistency */
    .nav .actions .btn{font-size:0.9rem!important;font-weight:600!important;letter-spacing:0.01em!important}
    .nav .actions a.btn{font-size:0.9rem!important;font-weight:600!important;letter-spacing:0.01em!important}
    .nav .actions button.btn{font-size:0.9rem!important;font-weight:600!important;letter-spacing:0.01em!important}
    .nav .actions button{font-size:0.9rem!important;font-weight:600!important;letter-spacing:0.01em!important}

    .hero{padding:40px 0}
    .hero h1{font-size:clamp(1.6rem,1.2rem + 2vw,2.4rem);margin:0 0 8px;font-weight:900}
    .tag{color:var(--accent);font-weight:800}
    .lede{color:var(--muted);max-width:60ch}

   .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
   /* Form inner grid: keep columns independent and equal width so one column's height
     doesn't stretch the other. Use align-items:start to prevent vertical stretching. */
   .form .grid.two-col-form{grid-template-columns:1fr 1fr;align-items:start}
   .form .grid.two-col-form .field{align-self:start}

   /* Add buttons in the food columns should have a fixed height and consistent width */
  .add-food-btn{height:40px;min-height:40px;display:inline-flex;align-items:center;justify-content:center;padding:0 12px;width:100%;max-width:360px}
  .add-food-btn.btn{padding:0 12px}    
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h2{margin:0 0 12px;font-size:1.2rem}

    .field{display:grid;gap:8px;margin:10px 0}
    label{font-weight:700}
    input[type=text], textarea, select{width:100%;padding:12px 14px;border:2px solid #e3e8e4;border-radius:12px;background:white;color:var(--ink);outline:none}
    input:focus, textarea:focus, select:focus{border-color:var(--primary);box-shadow:var(--ring)}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:680px){.row{grid-template-columns:1fr}}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid #eee;vertical-align:top}
    th{background:#f8faf7;text-align:left;position:sticky;top:0;z-index:2}
    tr.hover:hover{background:#faf9f6}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:.8rem;font-weight:700}
    .pill.ok{background:var(--ok)}
    .pill.warn{background:var(--warn)}
    .pill.danger{background:var(--danger)}
    .taglink{color:var(--muted);text-decoration:underline dotted}

    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
    .chip{border:2px solid #c6dacd;border-radius:999px;padding:6px 10px;font-weight:700;color:var(--muted);cursor:pointer}
    .chip.active{background:var(--primary);border-color:var(--primary);color:#fff}

    /* Food Entry Styles */
    .foodEntry{margin-bottom:16px}
    .foodEntry:last-child{margin-bottom:8px}
    .foodEntry select{margin-bottom:8px}
    .foodEntry textarea{margin-top:8px}
    .foodEntry .btn{font-size:0.8rem;padding:4px 8px;margin-top:4px}

    /* Non-similar ingredient row highlighting */
    tr.non-similar{background-color:#fff3e0}
    tr.non-similar:hover{background-color:#ffe0b2}
 
    /* Ingredient Auto-suggestion Styles */
    .ingredient-suggestions {
      position: absolute;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 8px;
      box-shadow: var(--shadow);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      width: 100%;
      display: none;
    }
    
    .ingredient-suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }
    
    .ingredient-suggestion-item:hover {
      background-color: var(--primary);
      color: white;
    }
    
    .ingredient-suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-highlight {
      background-color: var(--accent);
      color: white;
      padding: 1px 2px;
      border-radius: 2px;
    }
    
    .foodEntry {
      position: relative;
    }

    footer{margin-top:40px;border-top:1px solid #e9e1d7}
    footer .inner{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:center;padding:18px 0;color:var(--muted)}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:24px;z-index:10;overflow-y:auto}
    .modal.open{display:flex}
    @media (max-height: 600px) {
      .modal{align-items:flex-start;padding-top:60px}
    }
    .modal .sheet{max-width:900px;width:100%;background:var(--card);border-radius:20px;box-shadow:var(--shadow)}
    .modal-content{max-width:500px;width:100%;background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:0;overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:1px solid #e9e1d7}
    .modal-header h2{margin:0;color:var(--ink)}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{color:var(--ink)}
    .modal-body{padding:24px}
    #loginBtn:hover{background:#3367d6 !important; transform:translateY(-1px); box-shadow:0 4px 12px rgba(66,133,244,0.3)}
    .sheet .head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #eef2ef}
    .sheet h3{margin:0}
    .sheet .body{padding:12px 18px 22px}
    .glossary{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
   /* Keep glossary content from stretching the modal and allow internal scrolling
     when there are many results. When there are few results, align to start to
     prevent large empty gaps or layout shifts. */
   .modal .sheet .body{max-height:60vh;overflow:auto}
   .glossary{align-content:start;grid-auto-rows:minmax(min-content, max-content)}
    .gloss{border:1px solid #edf0ee;border-radius:14px;padding:10px}
    .gloss h4{margin:0 0 6px}
    .muted{color:var(--muted)}
    .sr{position:absolute;left:-10000px}
  </style>
  
  <!-- Favicon and meta tags -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <!-- <link rel="alternate icon" href="/favicon.ico"> -->
  <meta name="theme-color" content="#79C99E">

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Allergy Free Dog",
      "url": "https://allergenfreedog.com",
      "description": "A free online tool to compare dog food ingredients and detect potential allergens like gluten, poultry, soy, peas, and fish.",
      "applicationCategory": "PetCareApplication",
      "operatingSystem": "Any",
      "creator": {
        "@type": "Organization",
        "name": "Allergy Free Dog"
      },
      "keywords": ["dog food allergy", "pet nutrition", "dog food comparison", "allergen detection"],
      "featureList": [
        "Compare triggering vs safe foods",
        "Highlight potential allergens",
        "Ingredient glossary",
        "Safe food tester"
      ]
    }
  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4D9WRY7LV3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-4D9WRY7LV3');
  </script>
    
</head>
<body>
  <!-- Google Identity Services (GIS) client script (required for Google Sign-In) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Firebase SDKs (Auth + Firestore) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <header>
    <div class="container nav">
      <div class="brand" aria-label="allergenfreedog brand">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M20 20c0-4 3-7 7-7s7 3 7 7-3 7-7 7-7-3-7-7Z" fill="#79C99E"/><circle cx="48" cy="20" r="6" fill="#79C99E"/><circle cx="17" cy="36" r="5" fill="#79C99E"/><circle cx="35" cy="43" r="5" fill="#79C99E"/><path d="M20 53c6 5 18 5 24 0 5-4 6-11 2-16-6-7-22-7-28 0-4 5-3 12 2 16Z" fill="#FF9F68"/></svg>
        Allergen Free Dog
      </div>
      <div class="actions">
        <button class="btn ghost" id="openGlossary">Ingredient Glossary</button>
        <a class="btn ghost" href="allergy-testing.html">Allergy Testing Guide</a>
        <button class="btn" id="loginBtn" style="display: none; background: #4285f4; color: white; border: none;">Log In</button>
        <div id="userInfo" style="display: none;">
          <span id="userName"></span>
          <button class="btn ghost" id="logoutBtn">Log Out</button>
        </div>
        <a class="btn primary" href="#compare">Compare Now</a>
      </div>
    </div>
  </header>

  <!-- Direct Login Dialog Modal -->
  <div id="loginDialog" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sign In</h2>
        <button class="modal-close" id="closeLoginDialog">&times;</button>
      </div>
      <div class="modal-body">
        <p>Sign in with Google to access your saved data and preferences.</p>
        <div id="googleSignInButton" style="margin: 20px 0;"></div>
        <div id="dogManagement" style="display: none;">
          <h3>Your Dogs</h3>
          <div id="dogList"></div>
          <div id="createDogSection">
            <input type="text" id="newDogName" placeholder="Enter dog name" style="margin-right: 8px;">
            <button id="addDogBtn" class="btn primary">Add Dog</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Comparison Dialog Modal -->
  <div id="saveComparisonDialog" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sign In to Save Comparisons</h2>
        <button class="modal-close" id="closeSaveComparisonDialog">&times;</button>
      </div>
      <div class="modal-body">
        <p>Sign in with Google to save your dog profiles and food comparisons for later. This allows you to:</p>
        <ul style="margin: 16px 0; padding-left: 20px;">
          <li>Save comparison results for each of your dogs</li>
          <li>Load previous comparisons instantly</li>
          <li>Get personalized suggestions based on your dog's history</li>
        </ul>
        <div id="saveComparisonGoogleSignInButton" style="margin: 20px 0;"></div>
        <p style="font-size: 14px; color: var(--muted); margin-top: 16px;">
          Don't worry - you can still use the comparison tool without signing in!
        </p>
      </div>
    </div>
  </div>

  <!-- auth panel removed; login handled via dialog (not inlined) -->

<!-- dog panel removed; dog management via login dialog and Firestore flow -->

  <div id="noDogsMessage" class="container card" style="margin:12px 0; display:none;">
    <p>No dogs found for your account. Create a dog to start saving comparisons and getting suggestions.</p>
    <button id="createDemoDog" class="btn primary">Create a demo dog</button>
  </div>

  <main class="container hero">
    <div class="grid">
      <section class="card">
        <h1><span class="tag">Compare dog foods</span> and spot allergens instantly 🐾</h1>
        <p class="lede">Paste labels or pick built‑ins. We normalise ingredients and highlight <strong>gluten</strong>, <strong>poultry</strong>, common <strong>allergens</strong>, and <strong>overlaps</strong>. Fully client‑side — just upload this file to your InfinityFree hosting.</p>

        <form id="compare" class="form" aria-labelledby="compareHeading">
          <h2 id="compareHeading">Compare Dog Foods</h2>
          <div class="filters" role="group" aria-label="Filters">
            <button type="button" class="chip active" data-filter="showAll">Show all</button>
            <button type="button" class="chip" data-filter="allergens">Allergens only</button>
            <button type="button" class="chip" data-filter="overlap">Overlaps only</button>
          </div>

          <!-- per-column brand filters moved into each column for scoped filtering -->

          <div class="grid two-col-form">
            <div class="field">
              <label>Triggering Foods (Foods that caused problems)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <small class="muted">Filter by brand:</small>
                  <select class="brandFilter"><option value="">All brands</option></select>
                </div>
              <div id="triggeringFoods">
                <div class="foodEntry">
                  <select class="foodSelect" aria-describedby="triggeringHelp"></select>
                  <small class="muted">Pick a sample or "Custom (paste)"</small>
                  <textarea class="foodText" rows="3" placeholder="Paste ingredients separated by commas…"></textarea>
                  <div class="ingredient-suggestions" id="triggeringSuggestions"></div>
                </div>
              </div>
              <button type="button" class="btn ghost add-food-btn" id="addTriggeringFood">+ Add Another Triggering Food</button>
            </div>
            
            <div class="field">
              <label>Safe Foods (Foods that didn't cause problems)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <small class="muted">Filter by brand:</small>
                  <select class="brandFilter"><option value="">All brands</option></select>
                </div>
              <div id="safeFoods">
                <div class="foodEntry">
                  <select class="foodSelect" aria-describedby="safeHelp"></select>
                  <small class="muted">Pick a sample or "Custom (paste)"</small>
                  <textarea class="foodText" rows="3" placeholder="Paste ingredients separated by commas…"></textarea>
                  <div class="ingredient-suggestions" id="safeSuggestions"></div>
            </div>
          </div>
              <button type="button" class="btn ghost add-food-btn" id="addSafeFood">+ Add Another Safe Food</button>
            </div>
          </div>

          <div class="row" style="align-items:center">
            <div class="field">
              <label class="sr" for="safe">Preference toggles</label>
              <div class="filters">
                <label class="chip"><input type="checkbox" id="noGluten" checked> Gluten-free focus</label>
                <label class="chip"><input type="checkbox" id="noPoultry" checked> Chicken-free focus</label>
                <label class="chip"><input type="checkbox" id="hydrolysedLow" checked> Treat hydrolysed as low risk</label>
              </div>
            </div>
            <div class="field" style="text-align:right">
              <button type="submit" class="btn primary">Build Comparison</button>
              <button type="button" id="saveComparisonBtn" class="btn ghost" style="margin-left:8px;" disabled>Save Comparison</button>
            </div>
          </div>
        </form>
      </section>

      <aside class="card">
        <h2>How it works</h2>
        <ol>
          <li><strong>Triggering Foods:</strong> Add foods your dog ate that caused problems (allergies, upset stomach, etc.)</li>
          <li><strong>Safe Foods:</strong> Add foods your dog ate without any issues</li>
          <li>We normalise common ingredient names using an internal list.</li>
          <li>We identify "non-similar ingredients" - ingredients present in triggering foods but NOT in safe foods.</li>
          <li>We build a comparison table showing overlaps and allergen notes.</li>
          <li><strong>Safe Food Finder:</strong> After comparison, test new dog foods to see if they contain any "non-similar ingredients" that could cause problems.</li>
        </ol>
        <p class="muted">Tip: hydrolysed proteins are treated as low risk if you toggle it on.</p>
      </aside>
    </div>

    <section class="card" id="results" aria-live="polite" style="margin-top:18px">
      <h2>Results</h2>
      <div id="resultNote" class="muted">Fill the form above and click <em>Build Comparison</em>.</div>
      <div class="filters" id="legend" hidden>
        <span class="pill danger">High: gluten/poultry</span>
        <span class="pill warn">Possible: soy/corn/peas/yeast/fish</span>
        <span class="pill ok">Safe (based on filters)</span>
      </div>
      <div style="overflow:auto">
        <table id="compareTable"></table>
      </div>
    </section>

    <section class="card" id="safeFoodFinder" aria-live="polite" style="margin-top:18px; display: none;">
      <h2>Safe Food Finder</h2>
      <p class="muted">Test a new dog food to see if it contains any ingredients that could cause problems for your dog.</p>
      
      <div class="row">
        <div class="field">
          <label for="newFoodName">Food Name</label>
          <input type="text" id="newFoodName" placeholder="Enter the name of the food to test">
        </div>
        <div class="field">
          <label for="newFoodIngredients">Ingredients</label>
          <textarea id="newFoodIngredients" rows="3" placeholder="Paste ingredients separated by commas…"></textarea>
          <div class="ingredient-suggestions" id="newFoodSuggestions"></div>
        </div>
      </div>
      
      <div class="field" style="text-align:right">
        <button type="button" class="btn primary" id="testNewFood">Test Food Safety</button>
      </div>
      
      <div id="safetyResult" style="margin-top: 16px; display: none;">
        <h3 id="safetyTitle"></h3>
        <div id="safetyDetails"></div>
        <div id="ingredientTable" style="margin-top: 16px; display: none;">
          <h4>Ingredient Analysis</h4>
          <div style="overflow: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="padding: 12px 10px; border-bottom: 1px solid #eee; background: #f8faf7; text-align: left;">Ingredient Name</th>
                  <th style="padding: 12px 10px; border-bottom: 1px solid #eee; background: #f8faf7; text-align: left;">Status</th>
                  <th style="padding: 12px 10px; border-bottom: 1px solid #eee; background: #f8faf7; text-align: left;">Similar To (if problematic)</th>
                </tr>
              </thead>
              <tbody id="ingredientTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container inner">
      <small>© <span id="yr"></span> allergenfreedog • For information only — not veterinary advice.</small>
      <a href="#" id="openGlossary2" class="taglink">Open ingredient glossary</a>
    </div>
  </footer>

  <!-- Glossary Modal -->
  <div class="modal" id="glossaryModal" aria-hidden="true" role="dialog" aria-labelledby="gTitle">
    <div class="sheet">
      <div class="head">
        <h3 id="gTitle">Ingredient Glossary</h3>
        <button class="btn ghost" id="closeGlossary" aria-label="Close">Close</button>
      </div>
      <div class="body">
        <div class="field">
          <label for="gSearch">Search</label>
          <input id="gSearch" type="text" placeholder="Type to filter…" />
        </div>
        <div class="glossary" id="glossary"></div>
      </div>
    </div>
  </div>

  <script>
  // Global variables
  let nonSimilarIngredients = [];
  let triggeringFoodsData = [];
  let foodCatalog = [];
  let ingredientMaster = [];
  // store last comparison so toggles can re-render without re-calling the API
  let lastComparison = null;
  
  // Auth and Firebase variables
  let gisUser = null;
  let currentDogId = null;
  let userDogs = [];
  let auth = null;
  let db = null;

    // Initialize the application
    async function initializeApp() {
      try {
        await Promise.all([
          loadFoodCatalog(),
          loadIngredientMaster()
        ]);
  // populate brand filter then initialize entries
  populateBrandFilter();
  initializeFoodEntries();
        console.log('Application initialized successfully');
      } catch (error) {
        console.error('Failed to initialize application:', error);
        showError('Failed to load application data. Please refresh the page.');
      }
    }

    function populateBrandFilter(){
      // Build a map of lowercase -> original casing (first occurrence)
      const brandMap = {};
      foodCatalog.forEach(f => {
        const raw = (f.brand||'').trim();
        if(!raw) return;
        const key = raw.toLowerCase();
        if(!(key in brandMap)) brandMap[key] = raw; // keep first/original casing
      });
      const keys = Object.keys(brandMap).sort();
      // populate every per-column brandFilter
      document.querySelectorAll('.brandFilter').forEach(sel=>{
        sel.innerHTML = '<option value="">All brands</option>' + keys.map(k=>`<option value="${k}">${brandMap[k]}</option>`).join('');
        // ensure single listener: replace node
        const newSel = sel.cloneNode(true);
        sel.parentNode.replaceChild(newSel, sel);
        newSel.addEventListener('change', ()=>{
          // refresh only the selects inside the same column (closest .field parent)
          const field = newSel.closest('.field');
          if(!field) return;
          const brandFilter = (newSel.value||'').trim().toLowerCase();
          field.querySelectorAll('.foodEntry').forEach(fe=>{
            const selEl = fe.querySelector('.foodSelect');
            const prev = selEl.value;
            selEl.innerHTML='';
            const noneOp = document.createElement('option'); noneOp.value='(none)'; noneOp.textContent='(none)'; selEl.append(noneOp);
            foodCatalog.filter(f => !brandFilter || ((f.brand||'').trim().toLowerCase() === brandFilter)).forEach(f => {
              const text = `${f.brand}${f.brand? ' - ':' '}${f.name}`.trim();
              const op = document.createElement('option'); op.value = text; op.textContent = text; selEl.append(op);
            });
            const customOp = document.createElement('option'); customOp.value='Custom (paste)'; customOp.textContent='Custom (paste)'; selEl.append(customOp);
            try{ selEl.value = prev; }catch(e){}
          });
        });
      });
    }

    // Load food catalog from API
    async function loadFoodCatalog() {
      try {
        const response = await fetch('api/food_catalog.php');
        const result = await response.json();
        
        if (result.success) {
          foodCatalog = result.data;
        } else {
          throw new Error(result.message || 'Failed to load food catalog');
        }
      } catch (error) {
        console.error('Error loading food catalog:', error);
        throw error;
      }
    }

    // Load ingredient master list from API
    async function loadIngredientMaster() {
      try {
        const response = await fetch('api/ingredients.php');
        const result = await response.json();
        
        if (result.success) {
          ingredientMaster = result.data;
        } else {
          throw new Error(result.message || 'Failed to load ingredient master list');
        }
      } catch (error) {
        console.error('Error loading ingredient master list:', error);
        throw error;
      }
    }

    // Initialize food entry functionality
    function initializeFoodEntries() {
      // Set up initial food entries
      setupFoodEntry(document.querySelector('#triggeringFoods .foodEntry'), 'Sample Brand - Insect & Pea');
      setupFoodEntry(document.querySelector('#safeFoods .foodEntry'), '(none)');
      
      // Add event listeners for adding new foods
      document.getElementById('addTriggeringFood').addEventListener('click', () => addNewFood('triggeringFoods'));
      document.getElementById('addSafeFood').addEventListener('click', () => addNewFood('safeFoods'));
      
      // Set up ingredient suggestions for safe food finder
      setupIngredientSuggestions('newFoodIngredients', 'newFoodSuggestions');
    }

    function setupIngredientSuggestions(textareaId, suggestionsId) {
      const textarea = document.getElementById(textareaId);
      const suggestionsDiv = document.getElementById(suggestionsId);
      
      textarea.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        if (query.length < 2) {
          suggestionsDiv.style.display = 'none';
          return;
        }
        
        // Get the last word being typed (for comma-separated lists)
        const words = query.split(/[,\n]/);
        const lastWord = words[words.length - 1].trim();
        
        if (lastWord.length < 2) {
          suggestionsDiv.style.display = 'none';
          return;
        }
        
        // Find matching ingredients from master list
        const matches = ingredientMaster
          .filter(ingredient => cleanIngredientName(ingredient.name).includes(lastWord))
          .slice(0, 8); // Limit to 8 suggestions
        
        renderIngredientSuggestions(matches, suggestionsDiv, textarea, lastWord);
      });
      
      // Hide suggestions when textarea loses focus
      textarea.addEventListener('blur', () => {
        setTimeout(() => {
          suggestionsDiv.style.display = 'none';
        }, 200);
      });
      
      // Show suggestions when textarea gains focus (if there's text)
      textarea.addEventListener('focus', () => {
        const query = textarea.value.toLowerCase();
        if (query.length >= 2) {
          const words = query.split(/[,\n]/);
          const lastWord = words[words.length - 1].trim();
          if (lastWord.length >= 2) {
            const matches = ingredientMaster
              .filter(ingredient => cleanIngredientName(ingredient.name).includes(lastWord))
              .slice(0, 8);
            renderIngredientSuggestions(matches, suggestionsDiv, textarea, lastWord);
          }
        }
      });
    }

    function renderIngredientSuggestions(matches, suggestionsDiv, textarea, query) {
      suggestionsDiv.innerHTML = '';
      
      if (matches.length === 0) {
        suggestionsDiv.innerHTML = '<div class="ingredient-suggestion-item">No matches found</div>';
        suggestionsDiv.style.display = 'block';
        return;
      }
      
      matches.forEach(match => {
        const item = document.createElement('div');
        item.className = 'ingredient-suggestion-item';
        
        // Highlight the matching part
        const displayName = match.name;
        const highlightedName = displayName.replace(
          new RegExp(`(${query})`, 'gi'),
          '<span class="suggestion-highlight">$1</span>'
        );
        
        item.innerHTML = highlightedName;
        
        // Add note if available
        if (match.note) {
          const noteSpan = document.createElement('div');
          noteSpan.style.fontSize = '0.8em';
          noteSpan.style.color = 'var(--muted)';
          noteSpan.textContent = match.note;
          item.appendChild(noteSpan);
        }
        
        item.addEventListener('click', () => {
          // Replace the last word with the selected ingredient
          const currentValue = textarea.value;
          const words = currentValue.split(/[,\n]/);
          words[words.length - 1] = match.name;
          textarea.value = words.join(', ');
          
          // Hide suggestions
          suggestionsDiv.style.display = 'none';
          
          // Focus back to textarea
          textarea.focus();
        });
        
        suggestionsDiv.appendChild(item);
      });
      
      suggestionsDiv.style.display = 'block';
    }

    function setupFoodEntry(entry, defaultValue) {
      const select = entry.querySelector('.foodSelect');
      const textarea = entry.querySelector('.foodText');
      const suggestionsDiv = entry.querySelector('.ingredient-suggestions');
      
      // Build options for this select respecting brand filter
      // look for a local per-column brandFilter select inside the closest .field
      let brandFilter = '';
      const colField = entry.closest('.field');
      if(colField){
        const bf = colField.querySelector('.brandFilter');
        if(bf) brandFilter = (bf.value||'').trim().toLowerCase();
      }
  const noneOp = document.createElement('option'); noneOp.value='(none)'; noneOp.textContent='(none)'; select.append(noneOp);
  foodCatalog.filter(f => !brandFilter || ((f.brand||'').trim().toLowerCase() === brandFilter)).forEach(f => {
        const op = document.createElement('option');
        const text = `${f.brand}${f.brand? ' - ':' '}${f.name}`.trim();
        op.value = text;
        op.textContent = text;
        select.append(op);
      });
      const customOp = document.createElement('option'); customOp.value='Custom (paste)'; customOp.textContent='Custom (paste)'; select.append(customOp);
      
      select.value = defaultValue;
      
      // Set up change handler
      function updateTextarea() {
        const v = select.value;
        if(v !== "(none)" && v !== "Custom (paste)") {
          // Extract the food name from "Brand - Food Name" format
          const foodName = v.split(' - ').slice(1).join(' - ');
          const selectedFood = foodCatalog.find(f => f.name === foodName);
          if(selectedFood) {
            textarea.value = selectedFood.ingredients;
            textarea.disabled = false;
          }
        }
        else if(v==="(none)"){ 
          textarea.value = ''; 
          textarea.disabled = true; 
        }
        else { 
          textarea.value = '';
          textarea.placeholder = 'Paste ingredients separated by commas…'; 
          textarea.disabled = false; 
        }
      }
      
      select.addEventListener('change', updateTextarea);
      updateTextarea();
       
       // Set up ingredient suggestions for the textarea
       setupTextareaSuggestions(textarea, entry);
     }

     function setupTextareaSuggestions(textarea, entry) {
       const suggestionsDiv = entry.querySelector('.ingredient-suggestions');
       
       textarea.addEventListener('input', (e) => {
         const query = e.target.value.toLowerCase();
         if (query.length < 2) {
           suggestionsDiv.style.display = 'none';
           return;
         }
         
         // Get the last word being typed (for comma-separated lists)
         const words = query.split(/[,\n]/);
         const lastWord = words[words.length - 1].trim();
         
         if (lastWord.length < 2) {
           suggestionsDiv.style.display = 'none';
           return;
         }
         
         // Find matching ingredients from master list
         const matches = ingredientMaster
           .filter(ingredient => cleanIngredientName(ingredient.name).includes(lastWord))
           .slice(0, 8); // Limit to 8 suggestions
         
         renderIngredientSuggestions(matches, suggestionsDiv, textarea, lastWord);
       });
       
       // Hide suggestions when textarea loses focus
       textarea.addEventListener('blur', () => {
         setTimeout(() => {
           suggestionsDiv.style.display = 'none';
         }, 200);
       });
       
       // Show suggestions when textarea gains focus (if there's text)
       textarea.addEventListener('focus', () => {
         const query = textarea.value.toLowerCase();
         if (query.length >= 2) {
           const words = query.split(/[,\n]/);
           const lastWord = words[words.length - 1].trim();
           if (lastWord.length >= 2) {
             const matches = ingredientMaster
               .filter(ingredient => cleanIngredientName(ingredient.name).includes(lastWord))
               .slice(0, 8);
             renderIngredientSuggestions(matches, suggestionsDiv, textarea, lastWord);
           }
         }
       });
     }

    function addNewFood(containerId) {
      const container = document.getElementById(containerId);
      const newEntry = document.createElement('div');
      newEntry.className = 'foodEntry';
      newEntry.style.marginTop = '12px';
      
      newEntry.innerHTML = `
        <div style="display: flex; gap: 8px; align-items: center;">
          <select class="foodSelect"></select>
          <button type="button" class="btn ghost" style="padding: 4px 8px; font-size: 0.8rem;" onclick="removeFoodEntry(this)">Remove</button>
        </div>
        <small class="muted">Pick a sample or "Custom (paste)"</small>
        <textarea class="foodText" rows="3" placeholder="Paste ingredients separated by commas…"></textarea>
        <div class="ingredient-suggestions" id="newFoodSuggestions"></div>
      `;
      
      container.appendChild(newEntry);
      setupFoodEntry(newEntry, '(none)');
    }

    function removeFoodEntry(button) {
      button.closest('.foodEntry').remove();
    }

    // Filters
    let currentFilter = 'showAll';
    document.querySelectorAll('.chip[data-filter]').forEach(ch=>{
      ch.addEventListener('click',()=>{
        document.querySelectorAll('.chip[data-filter]').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active'); currentFilter = ch.dataset.filter; applyRowFilter();
      });
    });

    function collectProducts(){
      const triggering = [];
      const safe = [];
      
      // Collect triggering foods
      document.querySelectorAll('#triggeringFoods .foodEntry').forEach(entry => {
        const selectValue = entry.querySelector('.foodSelect').value;
        const txt = entry.querySelector('.foodText').value.trim();
        if(selectValue !== "(none)" && txt){ 
          // Extract food name from "Brand - Food Name" format
          const foodName = selectValue.split(' - ').slice(1).join(' - ');
          triggering.push({label: `Triggering: ${foodName}`, list: parseList(txt)}); 
        }
      });
      
      // Collect safe foods
      document.querySelectorAll('#safeFoods .foodEntry').forEach(entry => {
        const selectValue = entry.querySelector('.foodSelect').value;
        const txt = entry.querySelector('.foodText').value.trim();
        if(selectValue !== "(none)" && txt){ 
          // Extract food name from "Brand - Food Name" format
          const foodName = selectValue.split(' - ').slice(1).join(' - ');
          safe.push({label: `Safe: ${foodName}`, list: parseList(txt)}); 
        }
      });
      
      return { triggering, safe };
    }

    function parseList(text){
      return text
        .split(/,|;|\n/)
        .map(x => x
          .trim()
          .replace(/\s+/g, ' ')           // Replace multiple spaces with single space
          .replace(/[\u200B-\u200D\uFEFF]/g, '') // Remove zero-width spaces and BOM
          .replace(/[\u00A0\u1680\u180e\u2000-\u200a\u202f\u205f\u3000]/g, ' ') // Replace various space characters with regular space
          .trim()
        )
        .filter(x => x.length > 0)        // Remove empty strings
        .map(x => x.toLowerCase());        // Convert to lowercase for consistency
    }

    // Utility function to clean ingredient names consistently
    function cleanIngredientName(name) {
      return name
        .trim()
        .replace(/\s+/g, ' ')           // Replace multiple spaces with single space
        .replace(/[\u200B-\u200D\uFEFF]/g, '') // Remove zero-width spaces and BOM
        .replace(/[\u00A0\u1680\u180e\u2000-\u200a\u202f\u205f\u3000]/g, ' ') // Replace various space characters with regular space
        .trim()
        .toLowerCase();
    }

    function allergenClass(name, prefs){
      const raw = cleanIngredientName(name);
      // detect hydrolysed word anywhere
      const hydroRegex = /\bhydroly(s|z)ed\b|\bhydroly(s|z)sed\b/g;
      const hasHydro = hydroRegex.test(raw);

      // helper: try to find a matching ingredient in master list for a given candidate string
      function findIngredientCandidate(candidate){
        if(!candidate) return null;
        // exact match first
        let found = ingredientMaster.find(im => cleanIngredientName(im.name) === candidate);
        if(found) return found;
        // try case where candidate contains master name or vice-versa (covers 'chicken liver' inside longer strings)
        found = ingredientMaster.find(im => {
          const m = cleanIngredientName(im.name);
          return candidate.includes(m) || m.includes(candidate);
        });
        return found || null;
      }

      // strip hydrolysed and common suffixes like 'protein', 'gravy', 'extract' to get base candidate
      const withoutHydro = raw.replace(hydroRegex, '').replace(/\b(protein|proteins|gravy|extract|powder|meal)\b/g, '').replace(/[^a-z0-9\s\-]/g,' ').replace(/\s+/g,' ').trim();

      // attempt matches in order: exact raw, without hydro, then fuzzy contains
      let ingredient = findIngredientCandidate(raw) || findIngredientCandidate(withoutHydro);

      // if still not found, try token-based matching (look for any master token inside the raw string)
      if(!ingredient){
        for(const im of ingredientMaster){
          const m = cleanIngredientName(im.name);
          if(raw.includes(m) || withoutHydro.includes(m)) { ingredient = im; break; }
        }
      }

      // If no matching ingredient found, default to safe
      if(!ingredient) return 'ok';

      const tags = ingredient.tags || [];
      // identify category matches
      const isGluten = tags.includes('gluten') || raw.includes('gluten') || withoutHydro.includes('gluten');
      const isPoultry = tags.includes('poultry') || /\b(chicken|poultry|turkey)\b/.test(raw) || /\b(chicken|poultry|turkey)\b/.test(withoutHydro);

      // If user is focusing on gluten/poultry, force danger for those categories
      if(prefs.noGluten && isGluten) return 'danger';
      if(prefs.noPoultry && isPoultry) return 'danger';

      // if hydrolysed and user treats hydrolysed as low risk -> safe
      if(hasHydro && prefs.hydro) return 'ok';

      // otherwise follow master risk level, but allow downgrade when the user has NOT focused on that category
      let baseRisk = ingredient.risk_level || 'safe';
      if(baseRisk === 'danger'){
        // downgrade poultry/gluten dangers to 'warn' if the user hasn't enabled that focus
        if((isGluten && !prefs.noGluten) || (isPoultry && !prefs.noPoultry)){
          baseRisk = 'warn';
        }
      }

      if(baseRisk === 'danger') return 'danger';
      if(baseRisk === 'warn') return 'warn';
      return 'ok';
    }

    function noteFor(name){
      const raw = cleanIngredientName(name);
      // reuse matching logic: prefer exact then without hydro
      const hydroRegex = /\bhydroly(s|z)ed\b|\bhydroly(s|z)sed\b/g;
      const withoutHydro = raw.replace(hydroRegex, '').replace(/\b(protein|proteins|gravy|extract|powder|meal)\b/g, '').replace(/[^a-z0-9\s\-]/g,' ').replace(/\s+/g,' ').trim();
      let ingredient = ingredientMaster.find(im => cleanIngredientName(im.name) === raw) || ingredientMaster.find(im => cleanIngredientName(im.name) === withoutHydro);
      if(!ingredient){
        ingredient = ingredientMaster.find(im => raw.includes(cleanIngredientName(im.name)) || withoutHydro.includes(cleanIngredientName(im.name)));
      }
      return ingredient ? ingredient.note : '';
    }

    function applyRowFilter(){
      const rows = document.querySelectorAll('#compareTable tbody tr');
      rows.forEach(r=>{
        if(currentFilter==='showAll'){ r.hidden=false; return; }
        const isAllergen = r.dataset.risk!=='ok';
        const overlap = Number(r.dataset.count||0) >= 2;
        r.hidden = (currentFilter==='allergens' && !isAllergen) || (currentFilter==='overlap' && !overlap);
      });
    }

    // Handle form submission
    document.getElementById('compare').addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      const prefs = {
        noGluten: document.getElementById('noGluten').checked,
        noPoultry: document.getElementById('noPoultry').checked,
        hydro: document.getElementById('hydrolysedLow').checked
      };

      const { triggering, safe } = collectProducts();
      if(!triggering.length){ alert('Please add at least one triggering food.'); return; }
      if(!safe.length){ alert('Please add at least one safe food.'); return; }
      
      try {
        // Show loading state
        const submitBtn = document.querySelector('#compare button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Analyzing...';
        submitBtn.disabled = true;
        
        // Prepare data for API
        const apiData = {
          triggering: triggering.map(f => ({ name: f.label, ingredients: f.list.join(', ') })),
          safe: safe.map(f => ({ name: f.label, ingredients: f.list.join(', ') }))
        };
        
        // Call comparison API
        const response = await fetch('api/compare.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(apiData)
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Comparison failed');
        }
        
  // Store triggering foods data for safe food finder
  triggeringFoodsData = triggering;
  nonSimilarIngredients = result.data.nonSimilarIngredients;

  // Store last comparison data so we can re-render when toggles change
  lastComparison = { comparisonData: result.data.comparisonTable, triggering, safe };
  // Persist to Firestore if available (Firebase Option B)
  if (typeof saveComparisonToFirestore === 'function' && currentDogId) {
    saveComparisonToFirestore(currentDogId, {
      triggering,
      safe,
      comparisonTable: result.data.comparisonTable,
      timestamp: Date.now()
    }).catch(() => {});
  }

  // Build and display comparison table
  displayComparisonTable(result.data.comparisonTable, triggering, safe, prefs);
        
        // Show the safe food finder
        document.getElementById('safeFoodFinder').style.display = 'block';
        
        // Show success state for 10 seconds
        submitBtn.textContent = 'Done!';
        submitBtn.style.background = 'var(--ok)';
        submitBtn.disabled = false;
        
        // After 10 seconds, restore original button state
        setTimeout(() => {
          submitBtn.textContent = originalText;
          submitBtn.style.background = '';
        }, 10000);
        
      } catch (error) {
        console.error('Comparison failed:', error);
        alert('Comparison failed: ' + error.message);
        
        // Restore button state on error
        const submitBtn = document.querySelector('#compare button[type="submit"]');
        submitBtn.textContent = 'Build Comparison';
        submitBtn.style.background = '';
        submitBtn.disabled = false;
      }
    });

    function displayComparisonTable(comparisonData, triggering, safe, prefs) {
      const allFoods = [...triggering, ...safe];
      const tbl = document.getElementById('compareTable');
      const cols = ['Ingredient', ...allFoods.map(p=>p.label), 'Allergen note'];
      tbl.innerHTML = '<thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody></tbody>';
      const body = tbl.querySelector('tbody');

      comparisonData.forEach(rowData => {
        const name = rowData.ingredient;
        
        // presence per product
        let count = 0; 
        const cells = allFoods.map(p => {
          const hit = rowData.presence[p.label];
          if(hit) count++; 
          return `<td>${hit ? '✅' : ''}</td>`;
        });
        
        // allergen note & class
        const risk = allergenClass(name, prefs);
        const cls = risk==='danger' ? 'pill danger' : risk==='warn' ? 'pill warn' : 'pill ok';
        const note = [noteFor(name) || ''].filter(Boolean).join(' ');
        
        // non-similar indicator
        const isNonSimilar = nonSimilarIngredients.includes(name);
        
        const tableRow = document.createElement('tr');
        tableRow.className = 'hover';
        if (isNonSimilar) {
          tableRow.classList.add('non-similar');
        }
        tableRow.dataset.count = count;
        tableRow.dataset.risk = risk;
        
        // Put warning pill after the ingredient name
        const ingredientName = isNonSimilar ? 
          `<strong>${name}</strong> <span class="pill danger" style="margin-left: 8px;">⚠️ NON-SIMILAR</span>` : 
          `<strong>${name}</strong>`;
        
        tableRow.innerHTML = `<td>${ingredientName}</td>${cells.join('')}<td><span class="${cls}">${risk.toUpperCase()}</span> ${note}</td>`;
        body.append(tableRow);
      });

      document.getElementById('legend').hidden = false;
      document.getElementById('resultNote').textContent = `${comparisonData.length} unique ingredients normalised. Found ${nonSimilarIngredients.length} non-similar ingredients. Click column headers to sort (browser shortcuts).`;
      applyRowFilter();
    }

    // Safe Food Finder functionality
    document.getElementById('testNewFood').addEventListener('click', async () => {
      const foodName = document.getElementById('newFoodName').value.trim();
      const ingredients = document.getElementById('newFoodIngredients').value.trim();
      
      if (!foodName || !ingredients) {
        alert('Please enter both food name and ingredients.');
        return;
      }
      
      if (nonSimilarIngredients.length === 0) {
        alert('Please run a comparison first to identify non-similar ingredients.');
        return;
      }
      
      try {
        // Show loading state
        const testBtn = document.getElementById('testNewFood');
        const originalText = testBtn.textContent;
        testBtn.textContent = 'Testing...';
        testBtn.disabled = true;
        
        // Call safe food finder API
        const response = await fetch('api/safe_food_finder.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            foodName: foodName,
            ingredients: ingredients,
            nonSimilarIngredients: nonSimilarIngredients
          })
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Food safety test failed');
        }
        
        // Display results
        displaySafeFoodResult(result.data);
        
        // Show success state for 10 seconds
        testBtn.textContent = 'Done!';
        testBtn.style.background = 'var(--ok)';
        testBtn.disabled = false;
        
        // After 10 seconds, restore original button state
        setTimeout(() => {
          testBtn.textContent = originalText;
          testBtn.style.background = '';
        }, 10000);
        
      } catch (error) {
        console.error('Safe food test failed:', error);
        alert('Food safety test failed: ' + error.message);
        
        // Restore button state on error
        const testBtn = document.getElementById('testNewFood');
        testBtn.textContent = originalText;
        testBtn.style.background = '';
        testBtn.disabled = false;
      }
    });

    function displaySafeFoodResult(data) {
      const resultDiv = document.getElementById('safetyResult');
      const titleEl = document.getElementById('safetyTitle');
      const detailsEl = document.getElementById('safetyDetails');
      const ingredientTableBody = document.getElementById('ingredientTableBody');
      
      if (data.problematicCount > 0) {
        titleEl.textContent = `⚠️ UNSAFE: ${data.foodName}`;
        titleEl.style.color = '#d32f2f';
        detailsEl.innerHTML = `
          <p>This food contains <strong>${data.problematicCount}</strong> ingredient(s) that caused problems for your dog:</p>
          <ul>
            ${data.problematicIngredients.map(ingredient => `<li><strong>${ingredient}</strong></li>`).join('')}
          </ul>
          <p class="muted">We recommend avoiding this food.</p>
        `;
      } else {
        titleEl.textContent = `✅ SAFE: ${data.foodName}`;
        titleEl.style.color = '#2e7d32';
        detailsEl.innerHTML = `
          <p>This food appears to be safe for your dog!</p>
          <p class="muted">No problematic ingredients were found that match your dog's known triggers.</p>
        `;
      }
      
      // Always show the ingredient analysis table
      resultDiv.style.display = 'block';
      document.getElementById('ingredientTable').style.display = 'block';
      
      // Populate the ingredient analysis table
      ingredientTableBody.innerHTML = '';
      data.ingredientAnalysis.forEach(ingredient => {
        const row = document.createElement('tr');
        const isNonSimilar = ingredient.status === 'Non-Similar';
        
        row.innerHTML = `
          <td style="padding: 12px 10px; border-bottom: 1px solid #eee;"><strong>${ingredient.ingredient}</strong></td>
          <td style="padding: 12px 10px; border-bottom: 1px solid #eee;"><span class="pill ${isNonSimilar ? 'danger' : 'ok'}">${ingredient.status}</span></td>
          <td style="padding: 12px 10px; border-bottom: 1px solid #eee;">${ingredient.similarTo}</td>
        `;
        ingredientTableBody.appendChild(row);
      });
    }

    // Utility function to show errors
    function showError(message) {
      // You can implement a proper error display system here
      console.error(message);
      alert(message);
    }

    // --- Glossary Modal ---
    const modal = document.getElementById('glossaryModal');
    const openBtns = [document.getElementById('openGlossary'), document.getElementById('openGlossary2')];
    const closeBtn = document.getElementById('closeGlossary');
    openBtns.forEach(b=>b.addEventListener('click', ()=>{ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); document.getElementById('gSearch').focus(); }));
    closeBtn.addEventListener('click', ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); });
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeBtn.click(); });

    // Populate glossary
    const gloss = document.getElementById('glossary');
    function renderGlossary(filter=''){
      gloss.innerHTML = '';
      const cleanFilter = cleanIngredientName(filter);
      ingredientMaster.filter(m => cleanIngredientName(m.name).includes(cleanFilter)).forEach(m=>{
        const card = document.createElement('div');
        card.className='gloss';
        const tag = m.tags.includes('gluten')? 'danger' : m.tags.includes('danger')? 'danger' : m.tags.includes('possible')? 'warn':'ok';
        card.innerHTML = `<h4>${m.name}</h4><p class="muted">${m.note||''}</p><span class="pill ${tag}">${tag.toUpperCase()}</span>`;
        gloss.append(card);
      });
    }
    renderGlossary();
    document.getElementById('gSearch').addEventListener('input', (e)=>renderGlossary(e.target.value));

    // year
    document.getElementById('yr').textContent = new Date().getFullYear();
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Live re-render when gluten/poultry toggles change (apply immediately to the existing table)
    document.getElementById('noGluten').addEventListener('change', ()=>{
      if(!lastComparison) return;
      const prefs = {
        noGluten: document.getElementById('noGluten').checked,
        noPoultry: document.getElementById('noPoultry').checked,
        hydro: document.getElementById('hydrolysedLow').checked
      };
      displayComparisonTable(lastComparison.comparisonData, lastComparison.triggering, lastComparison.safe, prefs);
    });

    document.getElementById('noPoultry').addEventListener('change', ()=>{
      if(!lastComparison) return;
      const prefs = {
        noGluten: document.getElementById('noGluten').checked,
        noPoultry: document.getElementById('noPoultry').checked,
        hydro: document.getElementById('hydrolysedLow').checked
      };
      displayComparisonTable(lastComparison.comparisonData, lastComparison.triggering, lastComparison.safe, prefs);
    });

    document.getElementById('loadLastBtn').addEventListener('click', async () => {
      if(!currentDogId){ alert('Please select a dog.'); return; }
      if(!auth || !auth.currentUser){ alert('Sign in to load saved comparisons.'); return; }
      try {
        const data = await loadLastComparisonFromFirestore(currentDogId);
        if(!data){ alert('No saved comparison found for this dog. Build one first or sign in with a different dog.'); return; }
        // Rehydrate UI using the saved data
        lastComparison = data;
        displayComparisonTable(data.comparisonTable, data.triggering, data.safe, {});
      } catch (e) {
        console.error(e);
        alert('Failed to load last comparison.');
      }
    });
  </script>

  <script>
    // Consolidated Firebase initialization and auth management
    (async function() {
      // Load Firebase config from git-ignored file if present
      try {
        const resp = await fetch('config/firebase.config.js', { cache: 'no-store' });
        if (resp.ok) {
          const text = await resp.text();
          new Function(text)();
        }
      } catch (e) {
        console.warn('Could not load Firebase config, using defaults');
      }

      const cfg = window.__firebaseConfig || {
        apiKey: 'YOUR_API_KEY',
        authDomain: 'YOUR_AUTH_DOMAIN',
        projectId: 'YOUR_PROJECT_ID',
        storageBucket: 'YOUR_STORAGE_BUCKET',
        messagingSenderId: 'YOUR_MESSAGING_SENDER_ID',
        appId: 'YOUR_APP_ID'
      };

      // Wait for Firebase to load
      while (typeof firebase === 'undefined') {
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Initialize Firebase
      const app = firebase.apps.length ? firebase.apps[0] : firebase.initializeApp(cfg);
      auth = firebase.auth();
      db = firebase.firestore();

      // Auth state listener
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          gisUser = { name: user.displayName || user.email, avatar: user.photoURL || '' };
          await loadUserData(user.uid);
          updateAuthUI(true);
        } else {
          gisUser = null;
          currentDogId = null;
          userDogs = [];
          updateAuthUI(false);
        }
      });

      // Initialize UI event listeners
      initializeAuthUI();
    })();

    // Auth UI management
    function updateAuthUI(isLoggedIn) {
      const loginBtn = document.getElementById('loginBtn');
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      const noDogsMessage = document.getElementById('noDogsMessage');
      const dogManagement = document.getElementById('dogManagement');

      if (isLoggedIn) {
        loginBtn.style.display = 'none';
        userInfo.style.display = 'flex';
        userName.textContent = gisUser.name;
        
        if (userDogs.length === 0) {
          noDogsMessage.style.display = 'block';
          dogManagement.style.display = 'none';
        } else {
          noDogsMessage.style.display = 'none';
          dogManagement.style.display = 'block';
          renderDogList();
        }
      } else {
        loginBtn.style.display = 'inline-block';
        userInfo.style.display = 'none';
        noDogsMessage.style.display = 'none';
        dogManagement.style.display = 'none';
      }
    }

    function initializeAuthUI() {
      // Login button - direct login dialog
      document.getElementById('loginBtn').addEventListener('click', () => {
        document.getElementById('loginDialog').style.display = 'flex';
        initializeGoogleSignIn('googleSignInButton');
      });

      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut();
      });

      // Close dialogs
      document.getElementById('closeLoginDialog').addEventListener('click', () => {
        document.getElementById('loginDialog').style.display = 'none';
      });

      document.getElementById('closeSaveComparisonDialog').addEventListener('click', () => {
        document.getElementById('saveComparisonDialog').style.display = 'none';
      });

      // Add dog button
      document.getElementById('addDogBtn').addEventListener('click', addDog);

      // Create demo dog button
      document.getElementById('createDemoDog').addEventListener('click', () => {
        document.getElementById('newDogName').value = 'Demo Dog';
        addDog();
      });

      // Close dialogs when clicking outside
      document.getElementById('loginDialog').addEventListener('click', (e) => {
        if (e.target.id === 'loginDialog') {
          document.getElementById('loginDialog').style.display = 'none';
        }
      });

      document.getElementById('saveComparisonDialog').addEventListener('click', (e) => {
        if (e.target.id === 'saveComparisonDialog') {
          document.getElementById('saveComparisonDialog').style.display = 'none';
        }
      });

      // Wire save comparison trigger
      wireSaveComparisonTrigger();
    }

    function initializeGoogleSignIn(buttonId = 'googleSignInButton') {
      if (window.google && window.google.accounts && window.google.accounts.id) {
        const clientId = cfg.clientId || cfg.apiKey;
        if (!clientId || clientId === 'YOUR_API_KEY' || clientId === 'YOUR_OAUTH_CLIENT_ID.apps.googleusercontent.com') {
          console.error('Google Sign-In: Client ID not configured properly');
          showError('Google Sign-In not configured. Please check your Firebase config.');
          return;
        }

        google.accounts.id.initialize({
          client_id: clientId,
          callback: handleGoogleSignIn,
          auto_select: false,
          cancel_on_tap_outside: true
        });
        google.accounts.id.renderButton(
          document.getElementById(buttonId),
          { 
            theme: 'outline', 
            size: 'large',
            text: 'signin_with',
            shape: 'rectangular',
            logo_alignment: 'left'
          }
        );
      } else {
        console.error('Google Identity Services not loaded');
        showError('Google Sign-In service not available. Please refresh the page.');
      }
    }

    function wireSaveComparisonTrigger() {
      // Find the form submission or save button and add the trigger
      const compareForm = document.getElementById('compare');
      if (compareForm) {
        compareForm.addEventListener('submit', (e) => {
          // Check if user is logged in before allowing save
          if (!auth.currentUser) {
            e.preventDefault();
            document.getElementById('saveComparisonDialog').style.display = 'flex';
            initializeGoogleSignIn('saveComparisonGoogleSignInButton');
            return false;
          }
        });
      }
    }

    function handleGoogleSignIn(response) {
      // Handle the Google Identity Services response
      if (response.credential) {
        const credential = firebase.auth.GoogleAuthProvider.credential(response.credential);
        auth.signInWithCredential(credential).then(() => {
          // Close both dialogs
          document.getElementById('loginDialog').style.display = 'none';
          document.getElementById('saveComparisonDialog').style.display = 'none';
        }).catch((error) => {
          console.error('Sign-in error:', error);
          showError('Sign-in failed. Please try again.');
        });
      } else {
        console.error('No credential received from Google Sign-In');
        showError('Sign-in failed. Please try again.');
      }
    }

    async function loadUserData(userId) {
      try {
        // Load user's dogs
        const dogsSnapshot = await db.collection('users').doc(userId).collection('dogs').get();
        userDogs = [];
        dogsSnapshot.forEach(doc => {
          userDogs.push({ id: doc.id, ...doc.data() });
        });

        // Select first dog if available
        if (userDogs.length > 0) {
          currentDogId = userDogs[0].id;
          await loadLastComparison(currentDogId);
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showError('Failed to load your data. Please try again.');
      }
    }

    function renderDogList() {
      const dogList = document.getElementById('dogList');
      dogList.innerHTML = userDogs.map(dog => 
        `<div class="dog-item" style="padding: 8px; border: 1px solid #e9e1d7; margin: 4px 0; border-radius: 8px; cursor: pointer; ${dog.id === currentDogId ? 'background: var(--primary); color: white;' : ''}" data-dog-id="${dog.id}">
          ${dog.name}
        </div>`
      ).join('');

      // Add click listeners
      dogList.querySelectorAll('.dog-item').forEach(item => {
        item.addEventListener('click', async () => {
          currentDogId = item.dataset.dogId;
          renderDogList(); // Re-render to update selection
          await loadLastComparison(currentDogId);
        });
      });
    }

    async function addDog() {
      const dogName = document.getElementById('newDogName').value.trim();
      if (!dogName) {
        alert('Please enter a dog name');
        return;
      }

      if (!auth.currentUser) {
        alert('Please sign in first');
        return;
      }

      try {
        const dogData = {
          name: dogName,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const docRef = await db.collection('users').doc(auth.currentUser.uid).collection('dogs').add(dogData);
        userDogs.push({ id: docRef.id, ...dogData });
        currentDogId = docRef.id;
        
        document.getElementById('newDogName').value = '';
        updateAuthUI(true);
        showSuccess('Dog added successfully!');
      } catch (error) {
        console.error('Error adding dog:', error);
        showError('Failed to add dog. Please try again.');
      }
    }

    async function loadLastComparison(dogId) {
      if (!dogId) return;

      try {
        const comparisonsSnapshot = await db.collection('users').doc(auth.currentUser.uid)
          .collection('dogs').doc(dogId).collection('comparisons')
          .orderBy('timestamp', 'desc').limit(1).get();

        if (!comparisonsSnapshot.empty) {
          const comparison = comparisonsSnapshot.docs[0].data();
          // Render the comparison in the UI
          renderComparison(comparison);
        }
      } catch (error) {
        console.error('Error loading last comparison:', error);
      }
    }

    function renderComparison(comparison) {
      // This would integrate with your existing comparison rendering logic
      console.log('Loading comparison:', comparison);
      // You can implement the specific rendering logic here based on your existing code
    }

    // Firestore functions for saving/loading comparisons
    async function saveComparisonToFirestore(dogId, data) {
      if (!auth.currentUser || !dogId) return false;

      try {
        await db.collection('users').doc(auth.currentUser.uid)
          .collection('dogs').doc(dogId).collection('comparisons').add({
            ...data,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        return true;
      } catch (error) {
        console.error('Error saving comparison:', error);
        return false;
      }
    }

    async function loadLastComparisonFromFirestore(dogId) {
      if (!auth.currentUser || !dogId) return null;

      try {
        const snapshot = await db.collection('users').doc(auth.currentUser.uid)
          .collection('dogs').doc(dogId).collection('comparisons')
          .orderBy('timestamp', 'desc').limit(1).get();
        
        return snapshot.empty ? null : snapshot.docs[0].data();
      } catch (error) {
        console.error('Error loading comparison:', error);
        return null;
      }
    }

    async function loadUserDogsFromFirestore(userId) {
      if (!userId) return [];

      try {
        const snapshot = await db.collection('users').doc(userId).collection('dogs').get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error loading dogs:', error);
        return [];
      }
    }

    // Utility functions
    function showError(message) {
      // You can implement a toast notification system here
      alert('Error: ' + message);
    }

    function showSuccess(message) {
      // You can implement a toast notification system here
      alert('Success: ' + message);
    }

    // Expose functions globally for compatibility
    window.saveComparisonToFirestore = saveComparisonToFirestore;
    window.loadLastComparisonFromFirestore = loadLastComparisonFromFirestore;
    window.loadUserDogsFromFirestore = loadUserDogsFromFirestore;
  </script>
</body>
</html>
